!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";const t=Symbol("M"),r=Symbol("IMMUT_BASE"),n="Map",o="Set",a="Array",s={Map:n,Set:o,Array:a},c="[object Object]",i="[object Map]",u="[object Set]",f="[object Array]",l="[object Function]",p={[i]:n,[u]:o,[f]:a,[c]:"Object"},y=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],d=["set","clear","delete"],h=["add","clear","delete"],v=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],m={[n]:["clear","delete","entries","forEach","get","has","keys","set","values"],[o]:["add","clear","delete","entries","forEach","has","keys","values"],[a]:v},b={[n]:["clear","set","delete"],[o]:["clear","add","delete"],[a]:v},M={[n]:["forEach","get"],[o]:["forEach"],[a]:["forEach","map"]},P={value:0,usablePrefix:1},O={autoFreeze:!1,usePatches:!1,fastModeRange:"array"},g=Object.prototype.toString;function k(e){return g.call(e)}function j(...e){return e}function x(e){return k(e)===c}function E(e){return k(e)===i}function T(e){return k(e)===u}function w(e){return k(e)===l}function _(e){const t=k(e);return![c,f,i,u,l].includes(t)}function D(e){var t=typeof e;return"number"===t||"string"===t&&/^[0-9]*$/.test(e)}const A={[c]:Object.prototype,[f]:Array.prototype,[i]:Map.prototype,[u]:Set.prototype,[l]:Function.prototype};function B(e){e.rootMeta.modified=!0;const t=e=>{e&&!e.modified&&(e.modified=!0,t(e.parentMeta))};t(e)}function F(e,r,n,o){return n?e[t]=r:(!function(e,t){const r=k(e),n=A[r]||Object.prototype,o=Object.create(null);t&&Object.assign(o,t),Object.setPrototypeOf(o,n),Object.setPrototypeOf(e,o)}(e,o),e.__proto__[t]=r),e}function S(e,t){const{finishDraft:r,ver:n,parentMeta:o=null,key:a,immutBase:s}=t,c=(i=k(e),p[i]);var i;let u=[],f=0,l=null;o&&(l=o.copy,f=function(e){const t=V(e);return t?t.level+1:1}(l),u=function(e,t){const r=[t],n=V(e);if(n&&n.level>0){const{keyPath:e}=n;return[...e,t]}return r}(l,a));const y={rootMeta:null,parentMeta:o,parent:l,selfType:c,self:e,copy:null,key:a,keyPath:u,level:f,proxyVal:null,proxyItems:null,modified:!1,scopes:[],isImmutBase:s,isDel:!1,isFast:!1,linkCount:1,finishDraft:r,ver:n,revoke:j};return y.rootMeta=0===f?y:o.rootMeta,y}function z(e){if(_(e))return!1;const r=e[t];return!!r&&!r.isImmutBase}function V(e){return e[t]}function I(e){return e?e[t]:null}function R(e,t){const r=e=>{if(_(e))return e;if(t){const t=V(e),r=null==t?void 0:t.copy;if(r&&t.level>0)return r}let n=e;if(Array.isArray(e)&&(n=e.slice(),n.forEach(((e,t)=>{n[t]=r(e)}))),T(e)){const t=Array.from(e);t.forEach(((e,n)=>{t[n]=r(e)})),n=new Set(t)}return E(e)&&(n=new Map(e),n.forEach(((e,t)=>{n.set(t,r(e))}))),x(e)&&(n={},Object.keys(e).forEach((t=>{n[t]=r(e[t])}))),n};return r(e)}function N(e,t,r){const{extraProps:n}=r,{copy:o,fast:s}=function(e,t){const{parentType:r,fastModeRange:n}=t;if(Array.isArray(e))return{copy:e.slice(),fast:!1};const o="array"===n&&r===a||"all"===n;let s=e;return e&&x(e)&&(s=Object.assign({},e)),E(e)&&(s=new Map(e)),T(e)&&(s=new Set(e)),{copy:s,fast:o}}(e,r);return F(o,t,s,n),{copy:o,fast:s}}function C(e){const{self:r,copy:s,modified:c}=e;let i=r;return s&&c&&(i=e.copy),function(e){e.scopes.forEach((e=>{const{modified:r,copy:s,parentMeta:c,key:i,self:u,revoke:f,proxyVal:l,isDel:p,isFast:y}=e;if(!s)return f();if(y?delete s[t]:delete s.__proto__[t],!c)return f();const d=r?s:u,h=c.copy,v=c.selfType;return v===n?(h.set(i,d),f()):v===o?(h.delete(l),h.add(d),f()):v===a||!0!==p?(h[i]=d,f()):void 0})),e.scopes.length=0}(e),i}function $(e){e.rootMeta.scopes.push(e)}function J(e,t){const{finishDraft:r=j,ver:n,traps:o,parentType:a,parentMeta:s,key:c,fastModeRange:i,immutBase:u,extraProps:f}=t,l=S(e,{finishDraft:r,ver:n,parentMeta:s,key:c,immutBase:u}),{copy:p,fast:y}=N(e,l,{parentType:a,fastModeRange:i,extraProps:f});if(l.copy=p,l.isFast=y,u){const e=new Proxy(p,o);l.proxyVal=e,l.revoke=j}else{const e=Proxy.revocable(p,o);l.proxyVal=e.proxy,l.revoke=e.revoke}return l}function K(e,t){const{key:r,parentMeta:s,ver:c,traps:i,parent:u,patches:f,inversePatches:l,usePatches:p,parentType:y,fastModeRange:d,immutBase:h,readOnly:v,extraProps:m}=t;if(v&&s){const{level:e,copy:t,self:n}=s;if(0===e)return t[r]=n[r],n[r]}const b=(e,t)=>{const r=t||"";if(_(e)||!e)return e;if(!s)throw new Error("[[ createMeta ]]: meta should not be null");if(!w(e)){let t=V(e);return t||(t=J(e,{key:r,parentMeta:s,parentType:y,ver:c,traps:i,fastModeRange:d,immutBase:h,readOnly:v,extraProps:m}),$(t),u[r]=t.copy),t.proxyVal}if(!function(e,t){return e===a||(M[e]||[]).includes(t)}(y,r))return e;if(s.proxyItems)return e;let P=[];if(y===o){const e=new Set;u.forEach((t=>e.add(b(t)))),G(e,s,{dataType:o,patches:f,inversePatches:l,usePatches:p}),P=F(e,s,d,m),s.copy=P}else if(y===n){const e=new Map;u.forEach(((t,r)=>e.set(r,b(t,r)))),G(e,s,{dataType:n,patches:f,inversePatches:l,usePatches:p}),P=F(e,s,d,m),s.copy=P}else y===a&&"sort"!==r&&(s.copy=s.copy||u.slice(),P=s.proxyVal);return s.proxyItems=P,e};return b(e,r)}function W(e){if(!x(e))return e;const t=V(e);return t?t.copy:e}function G(e,t,r){const{dataType:a}=r,s=e.delete.bind(e),c=e.clear.bind(e);if(e.delete=function(...e){return B(t),s(...e)},e.clear=function(...e){return B(t),c(...e)},a===o){const n=e.add.bind(e);e.add=function(...e){return B(t),Object.assign({meta:t},r),n(...e)}}if(a===n){const n=e.set.bind(e);e.set=function(...e){return B(t),Object.assign({meta:t},r),n(...e)}}}function L(e,t){const{op:r,key:s,value:c,calledBy:i,parentType:u,parentMeta:f}=t;if("toJSON"===r&&!c)return;const l=W(c);if(!f)return void(e[s]=l);const{self:p,copy:v}=f;!function(e){const{calledBy:t,parentMeta:r,op:s,parentType:c}=e;(["deleteProperty","set"].includes(t)||"get"===t&&(c===o&&h.includes(s)||c===a&&y.includes(s)||c===n&&d.includes(s)))&&B(r)}({calledBy:i,parentMeta:f,op:r,key:s,parentType:u});if((m[u]||[]).includes(r)&&w(c))return"slice"===r?p.slice:v?u===o||u===n?v[r].bind(v):v[r]:p[r].bind(p);if(!v)return l;const b=v[s],M=()=>{const e=I(b);e&&(e.isDel=!0)};if("deleteProperty"===i){const e=I(c);return e?e.isDel=!0:M(),void delete v[s]}v[s]=l,M(),(()=>{const e=I(c);e&&e.isDel&&(e.isDel=!1,e.key=s,e.keyPath=f.keyPath.concat([s]),e.level=f.level+1,e.parent=f.copy,e.parentMeta=f)})()}function U(e){if(_(e))return e;if(Array.isArray(e)&&e.length>0)return e.forEach(U),Object.freeze(e);if(T(e)){const t=e;t.add=()=>t,t.delete=()=>!1,t.clear=j;for(const e of t.values())Object.freeze(e);return Object.freeze(e)}if(E(e)){const t=e;t.set=()=>t,t.delete=()=>!1,t.clear=j;for(const e of t.values())Object.freeze(e);return Object.freeze(e)}return Object.getOwnPropertyNames(e).forEach((t=>{U(e[t])})),Object.freeze(e)}const X=["length","constructor","asymmetricMatch","nodeType","size"],q=[a,o,n];function H(e){var n,o,c,i;const u=e||{},f=u.onOperate,l=u.fastModeRange||O.fastModeRange,p=null!==(n=u[r])&&void 0!==n&&n,y=u.extraProps||null,d=null!==(o=u.readOnly)&&void 0!==o&&o,h=null!==(c=u.autoFreeze)&&void 0!==c?c:O.autoFreeze,v=null!==(i=u.usePatches)&&void 0!==i?i:O.usePatches,M=(e,t,r)=>{if(!r||!f)return;const{selfType:n,keyPath:o,self:a,copy:s}=r;let c="get"!==e,i=!1;if((m[n]||[]).includes(t)){i=!0;c=(b[n]||[]).includes(t)}f({parentType:n,op:e,isBuiltInFnKey:i,isChange:c,key:t,keyPath:o,fullKeyPath:o.concat(t),value:s[t]||a[t]})},g=(()=>{const e=function(){P.value>=Number.MAX_SAFE_INTEGER?(P.value=1,P.usablePrefix+=1):P.value+=1;const{value:e,usablePrefix:t}=P;return`${t}_${e}`}();let r=!0;const n=[],o=[],c={get:(r,i)=>{let u=r[i];if("toJSON"===i&&Array.isArray(r))return u;if("__proto__"===i||i===t)return u;if("symbol"==typeof i)return w(u)?u.bind(r):u;const f=V(r),y=null==f?void 0:f.selfType;return q.includes(y)&&X.includes(i)?f.copy[i]:(u=K(u,{key:i,parentMeta:f,parentType:y,ver:e,traps:c,parent:r,patches:n,fastModeRange:l,immutBase:p,readOnly:d,inversePatches:o,usePatches:v}),y===a&&D(i)?(M("get",i,f),u):s[y]?(u=L(r,{op:i,key:i,value:u,metaVer:e,calledBy:"get",patches:n,inversePatches:o,usePatches:v,parentType:y,parentMeta:f}),M("get",i,f),u):(M("get",i,f),u))},set:(t,n,o)=>{let s=o;if(d)return console.error("can not mutate state at readOnly mode!"),!0;if(z(o))if(i=e,x(c=o)&&V(c).ver!==i)r=!1;else if(s=W(o),s===t[n])return!0;var c,i;const u=V(t);if(u&&u.selfType===a){if(u.copy&&u.__callSet&&D(n))return u.copy[n]=s,M("set",n,u),!0;u.__callSet=!0}return L(t,{parentMeta:u,key:n,value:s,metaVer:e,calledBy:"set"}),M("set",n,u),!0},deleteProperty:(t,r)=>{const n=V(t);return L(t,{parentMeta:n,op:"del",key:r,value:"",metaVer:e,calledBy:"deleteProperty"}),M("del",r,n),!0},apply:function(e,t,r){return e.apply(t,r)}};return{createDraft:t=>{if(_(t))throw new Error("base state can not be primitive");let r=t;const n=V(t);if(n){if(p&&n.isImmutBase)return n.proxyVal;r=n.self}const o=J(r,{key:"",ver:e,traps:c,finishDraft:g.finishDraft,immutBase:p,readOnly:d,extraProps:y});return $(o),o.proxyVal},finishDraft:e=>{const t=V(e);if(!t)throw new Error("rootMeta should not be null!");if(0!==t.level)throw new Error("can not finish sub draft node!");if(t.isImmutBase)return e;let n=C(t);return h&&r&&(n=U(n)),n}}})();return g}function Q(e,t){return H(t).createDraft(e)}function Y(e){const t=V(e);let r=null;if(t&&(r=t.finishDraft),!r)throw new Error("not a Limu draft!");return r(e)}function Z(e){if(!w(e))throw new Error("produce callback is not a function")}function ee(e,t){if("AsyncFunction"===(r=e).constructor.name||"function"==typeof r.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(t))throw new Error("produce callback can not be a promise function or result");var r}function te(e,t,r){Z(t);const n=Q(e,r),o=t(n);return ee(t,o),Y(n)}const re=V,ne=z,oe=function(e,t,r){if(!t||!w(t)){const r=e,n=t;return Z(e),e=>te(e,r,n)}return te(e,t,r)},ae=U;const se=function(e){if(_(e))return e;const t=V(e);return(null==t?void 0:t.self)||e},ce=function(e){if(_(e))return e;const t=V(e);return t?R(t.copy||t.self):e};e.VER="3.4.1",e.createDraft=Q,e.current=ce,e.deepCopy=function(e){return R(e)},e.deepFreeze=ae,e.default=oe,e.finishDraft=Y,e.getAutoFreeze=function(){return O.autoFreeze},e.getDraftMeta=re,e.getMajorVer=function(){return 3},e.immut=function(e,t){return H(Object.assign(Object.assign({},t||{}),{readOnly:!0,[r]:!0})).createDraft(e)},e.isDraft=ne,e.original=se,e.produce=oe,e.setAutoFreeze=function(e){O.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
