!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a,o,i=Symbol("M"),u=Symbol("IMMUT_BASE"),f={add:"remove",remove:"add",set:"delete",delete:"set"},c="Map",l="Set",s="Array",p={Map:c,Set:l,Array:s},y="[object Object]",d="[object Map]",v="[object Set]",h="[object Array]",m="[object Function]",b=((r={})[d]=c,r[v]=l,r[h]=s,r[y]="Object",r),M=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],g=["set","clear","delete"],O=["add","clear","delete"],P=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],k=((t={}).Map=["clear","delete","entries","forEach","get","has","keys","set","values"],t.Set=["add","clear","delete","entries","forEach","has","keys","values"],t.Array=P,t),E=((n={}).Map=["clear","set","delete"],n.Set=["clear","add","delete"],n.Array=P,n),j=((a={}).Map=["forEach","get"],a.Set=["forEach"],a.Array=["forEach","map"],a),w={value:0,usablePrefix:1},T={autoFreeze:!1,usePatches:!1,fastModeRange:"array"},x=Object.prototype.toString;function A(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function B(e){return x.call(e)===y}function D(e){return x.call(e)===d}function S(e){return x.call(e)===v}function _(e){return x.call(e)===m}function z(e){var r,t=(r=e,x.call(r));return b[t]}function F(e){var r=x.call(e);return![y,h,d,v,m].includes(r)}function V(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}var I=((o={})[y]=Object.prototype,o[h]=Array.prototype,o[d]=Map.prototype,o[v]=Set.prototype,o[m]=Function.prototype,o);var R=function(){return R=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},R.apply(this,arguments)};function N(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}function C(e){e.rootMeta.modified=!0;var r=function(e){e&&!e.modified&&(e.modified=!0,r(e.parentMeta))};r(e)}function K(e,r,t){var n,a,o,u;return t?e[i]=r:(n=e,a=x.call(n),o=I[a]||Object.prototype,u=Object.create(null),Object.setPrototypeOf(u,o),Object.setPrototypeOf(n,u),e.__proto__[i]=r),e}function W(e,r){var t=r.finishDraft,n=r.ver,a=r.parentMeta,o=void 0===a?null:a,i=r.key,u=r.immutBase,f=z(e),c=[],l=0,s=null;o&&(l=function(e){var r=J(e);return r?r.level+1:1}(s=o.copy),c=function(e,r){var t=[r],n=J(e);return n&&n.level>0?N(N([],n.keyPath,!0),[r],!1):t}(s,i));var p={rootMeta:null,parentMeta:o,parent:s,selfType:f,self:e,copy:null,key:i,keyPath:c,level:l,proxyVal:null,proxyItems:null,modified:!1,scopes:[],isImmutBase:u,isDel:!1,linkCount:1,finishDraft:t,ver:n,revoke:A};return p.rootMeta=0===l?p:o.rootMeta,p}function G(e){if(F(e))return!1;var r=e[i];return!!r&&!r.isImmutBase}function J(e){return e[i]}function L(e){return e?e[i]:null}function U(e,r){var t=function(e){if(F(e))return e;if(r){var n=J(e),a=null==n?void 0:n.copy;if(a&&n.level>0)return a}var o=e;if(Array.isArray(e)&&(o=e.slice()).forEach((function(e,r){o[r]=t(e)})),S(e)){var i=Array.from(e);i.forEach((function(e,r){i[r]=t(e)})),o=new Set(i)}return D(e)&&(o=new Map(e)).forEach((function(e,r){o.set(r,t(e))})),B(e)&&(o={},Object.keys(e).forEach((function(r){o[r]=t(e[r])}))),o};return t(e)}function X(e,r,t){if(!t.immutBase){var n=function(e,r){var t=r.parentType,n=r.fastModeRange;if(Array.isArray(e))return{copy:e.slice(),fast:!1};var a="array"===n&&t===s||"all"===n,o=e;return e&&B(e)&&(o=R({},e)),D(e)&&(o=new Map(e)),S(e)&&(o=new Set(e)),{copy:o,fast:a}}(e,t);return K(n.copy,r,n.fast)}return K(e,r,!1)}function $(e){var r=e.self,t=e.copy,n=e.modified,a=r;return t&&n&&(a=e.copy),function(e){e.scopes.forEach((function(e){var r=e.modified,t=e.copy,n=e.parentMeta,a=e.key,o=e.self,u=e.revoke,f=e.proxyVal,p=e.isDel;if(!t)return u();if(delete t[i],!n)return u();var y=r?t:o,d=n.copy,v=n.selfType;return v===c?(d.set(a,y),u()):v===l?(d.delete(f),d.add(y),u()):v===s||!0!==p?(d[a]=y,u()):void 0})),e.scopes.length=0}(e),a}function q(e){e.rootMeta.scopes.push(e)}function H(e,r){var t=r.finishDraft,n=void 0===t?A:t,a=r.ver,o=r.traps,i=r.parentType,u=r.parentMeta,f=r.key,c=r.fastModeRange,l=r.immutBase,s=W(e,{finishDraft:n,ver:a,parentMeta:u,key:f,immutBase:l}),p=X(e,s,{parentType:i,fastModeRange:c,immutBase:l});if(s.copy=p,l){var y=new Proxy(p,o);s.proxyVal=y,s.revoke=A}else{y=Proxy.revocable(p,o);s.proxyVal=y.proxy,s.revoke=y.revoke}return s}function Q(e,r){var t=r.key,n=r.parentMeta,a=r.ver,o=r.traps,i=r.parent,u=r.patches,f=r.inversePatches,p=r.usePatches,y=r.parentType,d=r.fastModeRange,v=r.immutBase,h=r.readOnly,m=function(e,r){if(F(e)||!e)return e;var t=r||"",b=J(e);if(!_(e))return b||(q(b=H(e,{key:t,parentMeta:n,parentType:y,ver:a,traps:o,fastModeRange:d,immutBase:v,readOnly:h})),i[t]=b.copy),b.proxyVal;if(!function(e,r){return e===s||(j[e]||[]).includes(r)}(y,t))return e;if(!n)throw new Error("[[ createMeta ]]: oops, meta should not be null");if(n.proxyItems)return e;var M=[];if(y===l){var g=new Set;i.forEach((function(e){return g.add(m(e))})),ee(g,n,{dataType:l,patches:u,inversePatches:f,usePatches:p}),M=K(g,n,d),n.copy=M}else if(y===c){var O=new Map;i.forEach((function(e,r){return O.set(r,m(e,r))})),ee(O,n,{dataType:c,patches:u,inversePatches:f,usePatches:p}),M=K(O,n,d),n.copy=M}else y===s&&"sort"!==t&&(n.copy=n.copy||i.slice(),M=n.proxyVal);return n.proxyItems=M,e};return m(e,t)}function Y(e){if(!B(e))return e;var r=J(e);return r?r.copy:e}function Z(e){A(e,f)}function ee(e,r,t){var n=t.dataType,a=e.delete.bind(e),o=e.clear.bind(e);if(e.delete=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return C(r),a.apply(void 0,e)},e.clear=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return C(r),o.apply(void 0,e)},n===l){var i=e.add.bind(e);e.add=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return C(r),Z(R({meta:r},t)),i.apply(void 0,e)}}if(n===c){var u=e.set.bind(e);e.set=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return C(r),Z(R({meta:r},t)),u.apply(void 0,e)}}}function re(e,r){var t=r.op,n=r.key,a=r.value,o=r.calledBy,i=r.parentType,u=r.parentMeta;if("toJSON"!==t||a){var f=Y(a);if(u){var p=u.self,y=u.copy;if(function(e){var r=e.calledBy,t=e.parentMeta,n=e.op,a=e.parentType;(["deleteProperty","set"].includes(r)||"get"===r&&(a===l&&O.includes(n)||a===s&&M.includes(n)||a===c&&g.includes(n)))&&C(t)}({calledBy:o,parentMeta:u,op:t,key:n,parentType:i}),(k[i]||[]).includes(t)&&_(a))return"slice"===t?p.slice:y?i===l||i===c?y[t].bind(y):y[t]:p[t].bind(p);if(!y)return f;var d=y[n],v=function(){var e=L(d);e&&(e.isDel=!0)};if("deleteProperty"===o){var h=L(a);return h?h.isDel=!0:v(),void delete y[n]}y[n]=f,v(),function(){var e=L(a);e&&(e.isDel=!1)}()}else e[n]=f}}function te(e){if(F(e))return e;if(Array.isArray(e)&&e.length>0)return e.forEach(te),Object.freeze(e);if(S(e)){var r=e;return r.add=function(){return r},r.delete=function(){return!1},r.clear=A,Object.freeze(e)}if(D(e)){var t=e;return t.set=function(){return t},t.delete=function(){return!1},t.clear=A,Object.freeze(e)}return Object.getOwnPropertyNames(e).forEach((function(r){var t=e[r];t instanceof Object&&null!==t&&te(t)})),Object.freeze(e)}"function"==typeof SuppressedError&&SuppressedError;var ne=["length","constructor","asymmetricMatch","nodeType","size"],ae=[s,l,c];function oe(e){var r,t,n,a,o,f,c,l,y,d=e||{},v=d.onOperate,h=d.fastModeRange||T.fastModeRange,m=null!==(r=d[u])&&void 0!==r&&r,b=null!==(t=d.readOnly)&&void 0!==t&&t,M=null!==(n=d.autoFreeze)&&void 0!==n?n:T.autoFreeze,g=null!==(a=d.usePatches)&&void 0!==a?a:T.usePatches,O=function(e,r,t){if(t&&v){var n=t.selfType,a=t.keyPath,o=t.self,i=t.copy,u="get"!==e,f=!1;if((k[n]||[]).includes(r))f=!0,u=(E[n]||[]).includes(r);v({parentType:n,op:e,isBuiltInFnKey:f,isChange:u,key:r,keyPath:a,fullKeyPath:a.concat(r),value:i[r]||o[r]})}},P=(o=function(){w.value>=Number.MAX_SAFE_INTEGER?(w.value=1,w.usablePrefix+=1):w.value+=1;var e=w.value,r=w.usablePrefix;return"".concat(r,"_").concat(e)}(),f=!0,c=[],l=[],y={get:function(e,r){var t=e[r];if("__proto__"===r||r===i)return t;if("symbol"==typeof r)return _(t)?t.bind(e):t;var n=J(e),a=null==n?void 0:n.selfType;return n&&ae.includes(a)&&ne.includes(r)?n.copy[r]:(t=Q(t,{key:r,parentMeta:n,parentType:a,ver:o,traps:y,parent:e,patches:c,fastModeRange:h,immutBase:m,readOnly:b,inversePatches:l,usePatches:g}),a===s&&V(r)?(O("get",r,n),t):p[a]?(t=re(e,{op:r,key:r,value:t,metaVer:o,calledBy:"get",patches:c,inversePatches:l,usePatches:g,parentType:a,parentMeta:n}),O("get",r,n),t):(O("get",r,n),t))},set:function(e,r,t){var n,a,u=t;if(r===i)return e[r]=u,!0;if(b)return console.warn("modify fail at readOnly mode"),!0;if(G(t))if(a=o,B(n=t)&&J(n).ver!==a)f=!1;else if((u=Y(t))===e[r])return!0;var c=J(e);if(c&&c.selfType===s){if(c.copy&&c.__callSet&&V(r))return c.copy[r]=u,O("set",r,c),!0;c.__callSet=!0}return re(e,{parentMeta:c,key:r,value:u,metaVer:o,calledBy:"set"}),O("set",r,c),!0},deleteProperty:function(e,r){var t=J(e);return re(e,{parentMeta:t,op:"del",key:r,value:"",metaVer:o,calledBy:"deleteProperty"}),O("del",r,t),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(e){if(F(e))throw new Error("base state can not be primitive");var r=e,t=J(e);if(t){if(m&&t.isImmutBase)return t.proxyVal;r=t.self}var n=H(r,{key:"",ver:o,traps:y,finishDraft:P.finishDraft,immutBase:m,readOnly:b});return q(n),n.proxyVal},finishDraft:function(e){var r=J(e);if(!r)throw new Error("oops, rootMeta should not be null!");if(0!==r.level)throw new Error("oops, can not finish sub draft node!");if(r.isImmutBase)return e;var t=$(r);return M&&f&&(t=te(t)),t}});return P}function ie(e,r){return oe(r).createDraft(e)}function ue(e){var r=J(e),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function fe(e){if(!_(e))throw new Error("produce callback is not a function")}function ce(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function or result");var t}function le(e,r,t){fe(r);var n=ie(e,t),a=r(n);return ce(r,a),ue(n)}var se=J,pe=G,ye=function(e,r,t){if(!r||!_(r)){var n=e,a=r;return fe(e),function(e){return le(e,n,a)}}return le(e,r,t)},de=te;var ve=function(e){if(F(e))return e;var r=J(e);return(null==r?void 0:r.self)||e},he=function(e){if(F(e))return e;var r=J(e);return r?U(r.copy||r.self):e};e.VER="3.3.6",e.createDraft=ie,e.current=he,e.deepCopy=function(e){return U(e)},e.deepFreeze=de,e.default=ye,e.finishDraft=ue,e.getAutoFreeze=function(){return T.autoFreeze},e.getDraftMeta=se,e.getMajorVer=function(){return 3},e.immut=function(e){var r;return oe(((r={readOnly:!0})[u]=!0,r)).createDraft(e)},e.isDraft=pe,e.original=ve,e.produce=ye,e.setAutoFreeze=function(e){T.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
