!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a=function(){return a=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},a.apply(this,arguments)};function o(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}var i="Map",u="Set",f="Array",c={Map:i,Set:u,Array:f},l="[object Object]",s="[object Map]",p="[object Set]",y="[object Array]",v="[object Function]",d=((r={})[s]=i,r[p]=u,r[y]=f,r[l]="Object",r),h=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],b=["clear","delete","set"],m=["add","clear","delete"];o(o([],["entries","keys","values","has"],!0),["size"],!1);o(o([],["entries","has","keys","values"],!0),["size"],!1);var M=((t={})[c.Map]=["clear","delete","entries","forEach","get","has","keys","set","values"],t[c.Set]=["add","clear","delete","entries","forEach","has","keys","values"],t[c.Array]=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),k=((n={})[c.Map]=["forEach","get"],n[c.Set]=["forEach"],n[c.Array]=["forEach","map"],n),w=Object.prototype.toString;function g(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function E(e){return w.call(e)===l}function D(e){return w.call(e)===s}function P(e){return w.call(e)===p}function A(e){return w.call(e)===v}function j(e){var r,t=(r=e,w.call(r));return d[t]}function x(e){var r=w.call(e);return![l,y,s,p,v].includes(r)}function O(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}var S=Symbol("V"),z=Symbol("M"),T=Symbol("limu-finishHandler"),_={value:0,usablePrefix:1},F={autoFreeze:!0,usePatches:!1};function V(e){e.rootMeta.modified=!0;var r=function(e){e&&(e.modified=!0,r(e.parentMeta))};r(e)}function B(e,r){return e[z]=r,e}function I(e,r){var t=r.finishDraft,n=r.ver,a=r.parentMeta,i=void 0===a?null:a,u=r.key,f=j(e),c=[],l=0,s=null;i&&(l=function(e){var r=L(e);return r?r.level+1:1}(s=i.copy),c=function(e,r){var t=[r],n=L(e);return n&&n.level>0?o(o([],n.keyPath,!0),[r],!1):t}(s,u));var p={rootMeta:null,parentMeta:i,parent:s,selfType:f,self:e,copy:null,key:u,keyPath:c,level:l,proxyVal:null,proxyItems:null,modified:!1,scopes:[],finishDraft:t,ver:n,revoke:g};return p.rootMeta=0===l?p:i.rootMeta,p}function N(e){return!x(e)&&!!e[z]}function L(e){return e[z]}function R(e,r){var t=function(e){if(x(e))return e;if(r){var n=L(e),a=null==n?void 0:n.copy;if(a&&n.level>0)return a}var o=e;if(Array.isArray(e)&&(o=e.slice()).forEach((function(e,r){o[r]=t(e)})),P(e)){var i=Array.from(e);i.forEach((function(e,r){i[r]=t(e)})),o=new Set(i)}return D(e)&&(o=new Map(e)).forEach((function(e,r){o.set(r,t(e))})),E(e)&&(o={},Object.keys(e).forEach((function(r){o[r]=t(e[r])}))),o};return t(e)}function W(e,r){return B(function(e,r){if(Array.isArray(e))return e.slice();if(e&&E(e))return a({},e);if(D(e))return new Map(e);if(P(e))return new Set(e);if(r)throw new Error("make copy err, type can only be object(except null) or array");return e}(e,!0),r)}function C(e,r){var t=r.finishDraft,n=void 0===t?g:t,a=r.ver,o=r.traps,i=I(e,{finishDraft:n,ver:a,parentMeta:r.parentMeta,key:r.key}),u=W(e,i);i.copy=u;var f=Proxy.revocable(u,o);return i.proxyVal=f.proxy,i.revoke=f.revoke,i}function G(e){if(!E(e))return e;var r=L(e);return r?r.copy:e}function H(e){if(x(e))return e;if(Array.isArray(e)&&e.length>0)return e.forEach((function(e){H(e)})),Object.freeze(e);if(P(e)){var r=e;return r.add=function(){return r},r.delete=function(){return!1},r.clear=g,Object.freeze(e)}if(D(e)){var t=e;return t.set=function(){return t},t.delete=function(){return!1},t.clear=g,Object.freeze(e)}return Object.getOwnPropertyNames(e).forEach((function(r){var t=e[r];t instanceof Object&&null!==t&&H(t)})),Object.freeze(e)}function J(e,r,t){var n=t.dataType,a=e.delete.bind(e),o=e.clear.bind(e);if(e.delete=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return V(r),a.apply(void 0,e)},e.clear=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return V(r),o.apply(void 0,e)},"Set"===n){var i=e.add.bind(e);e.add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return V(r),i.apply(void 0,e)}}if("Map"===n){var u=e.set.bind(e);e.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return V(r),u.apply(void 0,e)}}}function X(e,r){var t=r.op,n=r.key,a=r.value,o=r.calledBy,i=r.parentType,u=L(e),f=G(a);if(u){var l=u.self,s=u.copy;if(function(e){var r=e.calledBy,t=e.parentDataNodeMeta,n=e.op,a=e.parentType;(["deleteProperty","set"].includes(r)||"get"===r&&("Set"===a&&m.includes(n)||"Array"===a&&h.includes(n)||"Map"===a&&b.includes(n)))&&V(t)}({calledBy:o,parentDataNodeMeta:u,op:t,key:n,parentType:i}),(M[i]||[]).includes(t)&&A(a))return"slice"===t?l.slice:s?i===c.Set||i===c.Map?s[t].bind(s):s[t]:l[t].bind(l);if(!s)return f;if("toJSON"!==t||a)if("deleteProperty"===o){var p=L(a);if(p)p.isDel=!0;else if(e[n]){var y=L(e[n]);y&&(y.isDel=!0)}delete s[n]}else s[n]=f}else e[n]=f}function $(e){var r=e.self,t=e.copy,n=e.modified,a=r;return t&&n&&(a=e.copy),function(e){e.scopes.forEach((function(e){var r=e.modified,t=e.copy,n=e.parentMeta,a=e.key,o=e.self,c=e.revoke,l=e.proxyVal,s=e.isDel;if(!t)return c();if(delete t[z],!n)return c();var p=r?t:o,y=n.copy,v=n.selfType;return v===i?(y.set(a,p),c()):v===u?(y.delete(l),y.add(p),c()):v===f||!0!==s?(y[a]=p,c()):void 0})),e.scopes.length=0}(e),a}function q(e){e.rootMeta.scopes.push(e)}var K=["length","constructor","asymmetricMatch","nodeType","size"],Q=[f,u,i];function U(){var e,r,t,n,a,o,l,s,p=(e=function(){_.value>=Number.MAX_SAFE_INTEGER?(_.value=1,_.usablePrefix+=1):_.value+=1;var e=_.value,r=_.usablePrefix;return"".concat(r,"_").concat(e)}(),r=!1,t=F.autoFreeze,n=!0,a=F.usePatches,o=[],l=[],s={get:function(r,t){if(t===S)return e;var n=r[t];if("__proto__"===t||t===T||t===z)return n;if("symbol"==typeof t)return A(n)?n.bind(r):n;var f=L(r),p=null==f?void 0:f.selfType;if(f&&Q.includes(p)&&K.includes(t))return f.copy[t];var y=function(t,n){if(x(t))return t;if(t){var v=(n||{}).key,d=void 0===v?"":v,h=L(t);if(A(t)){if(function(e,r){return"Array"===e||(k[e]||[]).includes(r)}(p,d)){if(!(h=L(r)))throw new Error("[[ createMeta ]]: oops, meta should not be null");if(!h.proxyItems){var b=[];if(p===u){var m=new Set;r.forEach((function(e){return m.add(y(e))})),J(m,h,{dataType:u,patches:o,inversePatches:l,usePatches:a}),b=B(m,h),f.copy=b}else if(p===i){var M=new Map;r.forEach((function(e,r){return M.set(r,y(e,{key:r}))})),J(M,h,{dataType:i,patches:o,inversePatches:l,usePatches:a}),b=B(M,h),f.copy=b}else p===c.Array&&(h.copy=h.copy||r.slice(),b=h.proxyVal);h.proxyItems=b}}return t}return h||(q(h=C(t,{key:d,parentMeta:f,ver:e,traps:s})),r[d]=h.copy),h.proxyVal}return t};return n=y(n,{key:t}),p===c.Array&&O(t)?n:c[p]?X(r,{op:t,key:t,value:n,metaVer:e,calledBy:"get",patches:o,inversePatches:l,usePatches:a,parentType:p}):n},set:function(r,t,a){var o,i,u=a;if(N(a))if(i=e,E(o=a)&&L(o).ver!==i)n=!1;else if((u=G(a))===r[t])return!0;if(t===z)return r[t]=u,!0;var c=L(r),l=c.selfType===f;if(c&&l){if(c.copy&&c.__callSet&&l&&O(t))return c.copy[t]=u,!0;c.__callSet=!0}return X(r,{key:t,value:u,metaVer:e,calledBy:"set"}),!0},deleteProperty:function(r,t){return X(r,{op:"del",key:t,value:"",metaVer:e,calledBy:"deleteProperty"}),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(n,o){var i,u,f=o||{};if(t=null!==(i=f.autoFreeze)&&void 0!==i?i:t,a=null!==(u=f.usePatches)&&void 0!==u?u:a,r)throw new Error("can not call new Limu().createDraft twice");var c=n;r=!0,N(n)&&(c=L(n).self);var l=C(c,{key:"",ver:e,traps:s,finishDraft:p.finishDraft});return q(l),l.proxyVal},finishDraft:function(r){var a=L(r);if(!a)throw new Error("oops, rootMeta should not be null!");if(0!==a.level)throw new Error("oops, can not finish sub draft node!");if(e!==a.ver)throw new Error("oops, the input draft does not match finishDraft handler");var o=$(a);return t&&n&&(o=H(o)),o}});return p}var Y=function(){var e=U();this.createDraft=e.createDraft,this.finishDraft=e.finishDraft};function Z(e,r){return(new Y).createDraft(e,r)}function ee(e){var r=L(e),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function re(e){if("function"!=typeof e)throw new Error("produce callback is not a function")}function te(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function");var t}function ne(e,r,t){re(r);var n=Z(e,t),a=r(n);return te(r,a),ee(n)}var ae=L,oe=N,ie=function(e,r,t){if(!r||"function"!=typeof r){var n=e,a=r;return re(e),function(e){return ne(e,n,a)}}return ne(e,r,t)},ue=H;var fe=function(e,r){if(!N(e))return e;var t=L(e),n=(null==t?void 0:t.self)||null;return r?n:n||null},ce=function(e){if(!N(e))return e;var r=L(e);return R(r.copy||r.self)};e.Limu=Y,e.createDraft=Z,e.current=ce,e.deepCopy=function(e){return R(e)},e.deepFreeze=ue,e.default=ie,e.finishDraft=ee,e.getAutoFreeze=function(){return F.autoFreeze},e.getDraftMeta=ae,e.getMajorVer=function(){return 3},e.isDraft=oe,e.original=fe,e.produce=ie,e.setAutoFreeze=function(e){F.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
