!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a=function(){return a=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},a.apply(this,arguments)};function o(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}"function"==typeof SuppressedError&&SuppressedError;var i=Symbol("M"),u="Map",c="Set",f="Array",l={Map:u,Set:c,Array:f},s="[object Object]",p="[object Map]",y="[object Set]",v="[object Array]",d="[object Function]",h=((r={})[p]=u,r[y]=c,r[v]=f,r[s]="Object",r),b=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],M=["clear","delete","set"],m=["add","clear","delete"];o(o([],["entries","keys","values","has"],!0),["size"],!1);o(o([],["entries","has","keys","values"],!0),["size"],!1);var k,P=((t={}).Map=["clear","delete","entries","forEach","get","has","keys","set","values"],t.Set=["add","clear","delete","entries","forEach","has","keys","values"],t.Array=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),E=((n={}).Map=["forEach","get"],n.Set=["forEach"],n.Array=["forEach","map"],n),g=Object.prototype.toString;function w(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function j(e){return g.call(e)===s}function D(e){return g.call(e)===p}function O(e){return g.call(e)===y}function A(e){return g.call(e)===d}function x(e){var r,t=(r=e,g.call(r));return h[t]}function T(e){var r=g.call(e);return![s,v,p,y,d].includes(r)}function S(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}var _=((k={})[s]=Object.prototype,k[v]=Array.prototype,k[p]=Map.prototype,k[y]=Set.prototype,k[d]=Function.prototype,k);var z={value:0,usablePrefix:1},F={autoFreeze:!0,usePatches:!1};function V(e){e.rootMeta.modified=!0;var r=function(e){e&&(e.modified=!0,r(e.parentMeta))};r(e)}function B(e,r,t){var n,a,o,u;return t?e[i]=r:(n=e,a=g.call(n),o=_[a]||Object.prototype,u=Object.create(null),Object.setPrototypeOf(u,o),Object.setPrototypeOf(n,u),e.__proto__[i]=r),e}function I(e,r){var t=r.finishDraft,n=r.ver,a=r.parentMeta,i=void 0===a?null:a,u=r.key,c=x(e),f=[],l=0,s=null;i&&(l=function(e){var r=N(e);return r?r.level+1:1}(s=i.copy),f=function(e,r){var t=[r],n=N(e);return n&&n.level>0?o(o([],n.keyPath,!0),[r],!1):t}(s,u));var p={rootMeta:null,parentMeta:i,parent:s,selfType:c,self:e,copy:null,key:u,keyPath:f,level:l,proxyVal:null,proxyItems:null,modified:!1,scopes:[],linkCount:1,finishDraft:t,ver:n,revoke:w};return p.rootMeta=0===l?p:i.rootMeta,p}function L(e){return!T(e)&&!!e[i]}function N(e){return e[i]}function R(e){return e?e[i]:null}function W(e,r){var t=function(e){if(T(e))return e;if(r){var n=N(e),a=null==n?void 0:n.copy;if(a&&n.level>0)return a}var o=e;if(Array.isArray(e)&&(o=e.slice()).forEach((function(e,r){o[r]=t(e)})),O(e)){var i=Array.from(e);i.forEach((function(e,r){i[r]=t(e)})),o=new Set(i)}return D(e)&&(o=new Map(e)).forEach((function(e,r){o.set(r,t(e))})),j(e)&&(o={},Object.keys(e).forEach((function(r){o[r]=t(e[r])}))),o};return t(e)}function C(e,r,t){return B(function(e,r){if(Array.isArray(e))return e.slice();if(e&&j(e))return a({},e);if(D(e))return new Map(e);if(O(e))return new Set(e);if(r)throw new Error("make copy err, type can only be object(except null) or array");return e}(e,!0),r,t)}function G(e){var r=e.self,t=e.copy,n=e.modified,a=r;return t&&n&&(a=e.copy),function(e){e.scopes.forEach((function(e){var r=e.modified,t=e.copy,n=e.parentMeta,a=e.key,o=e.self,l=e.revoke,s=e.proxyVal,p=e.isDel;if(!t)return l();if(delete t[i],!n)return l();var y=r?t:o,v=n.copy,d=n.selfType;return d===u?(v.set(a,y),l()):d===c?(v.delete(s),v.add(y),l()):d===f||!0!==p?(v[a]=y,l()):void 0})),e.scopes.length=0}(e),a}function J(e){e.rootMeta.scopes.push(e)}function X(e,r){var t=r.finishDraft,n=void 0===t?w:t,a=r.ver,o=r.traps,i=r.parentMeta,u=r.key,c=r.fast,f=I(e,{finishDraft:n,ver:a,parentMeta:i,key:u}),l=C(e,f,c);f.copy=l;var s=Proxy.revocable(l,o);return f.proxyVal=s.proxy,f.revoke=s.revoke,f}function $(e,r){var t=r.key,n=r.parentMeta,a=r.ver,o=r.traps,i=r.parent,l=r.patches,s=r.inversePatches,p=r.usePatches,y=r.parentType,v=r.fast,d=function(e,r){if(T(e)||!e)return e;var t=r||"",h=N(e);if(!A(e))return h||(J(h=X(e,{key:t,parentMeta:n,ver:a,traps:o,fast:v})),i[t]=h.copy),h.proxyVal;if(!function(e,r){return e===f||(E[e]||[]).includes(r)}(y,t))return e;if(!n)throw new Error("[[ createMeta ]]: oops, meta should not be null");if(n.proxyItems)return e;var b=[];if(y===c){var M=new Set;i.forEach((function(e){return M.add(d(e))})),H(M,n,{dataType:c,patches:l,inversePatches:s,usePatches:p}),b=B(M,n,v),n.copy=b}else if(y===u){var m=new Map;i.forEach((function(e,r){return m.set(r,d(e,r))})),H(m,n,{dataType:u,patches:l,inversePatches:s,usePatches:p}),b=B(m,n,v),n.copy=b}else y===f&&"sort"!==t&&(n.copy=n.copy||i.slice(),b=n.proxyVal);return n.proxyItems=b,e};return d(e,t)}function q(e){if(!j(e))return e;var r=N(e);return r?r.copy:e}function H(e,r,t){var n=t.dataType,a=e.delete.bind(e),o=e.clear.bind(e);if(e.delete=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return V(r),a.apply(void 0,e)},e.clear=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return V(r),o.apply(void 0,e)},n===c){var i=e.add.bind(e);e.add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return V(r),i.apply(void 0,e)}}if(n===u){var f=e.set.bind(e);e.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return V(r),f.apply(void 0,e)}}}function K(e,r){var t=r.op,n=r.key,a=r.value,o=r.calledBy,i=r.parentType,l=r.parentMeta;if("toJSON"!==t||a){var s=q(a);if(l){var p=l.self,y=l.copy;if(function(e){var r=e.calledBy,t=e.parentMeta,n=e.op,a=e.parentType;(["deleteProperty","set"].includes(r)||"get"===r&&(a===c&&m.includes(n)||a===f&&b.includes(n)||a===u&&M.includes(n)))&&V(t)}({calledBy:o,parentMeta:l,op:t,key:n,parentType:i}),(P[i]||[]).includes(t)&&A(a))return"slice"===t?p.slice:y?i===c||i===u?y[t].bind(y):y[t]:p[t].bind(p);if(!y)return s;var v=y[n],d=function(){var e=R(v);e&&(e.isDel=!0)};if("deleteProperty"===o){var h=R(a);return h?h.isDel=!0:d(),void delete y[n]}y[n]=s,d(),function(){var e=R(a);e&&(e.isDel=!1)}()}else e[n]=s}}function Q(e){if(T(e))return e;if(Array.isArray(e)&&e.length>0)return e.forEach((function(e){Q(e)})),Object.freeze(e);if(O(e)){var r=e;return r.add=function(){return r},r.delete=function(){return!1},r.clear=w,Object.freeze(e)}if(D(e)){var t=e;return t.set=function(){return t},t.delete=function(){return!1},t.clear=w,Object.freeze(e)}return Object.getOwnPropertyNames(e).forEach((function(r){var t=e[r];t instanceof Object&&null!==t&&Q(t)})),Object.freeze(e)}var U=["length","constructor","asymmetricMatch","nodeType","size"],Y=[f,c,u];function Z(e){var r,t,n,a,o,u,c,s,p,y=e||{},v=y.onRead||w,d=y.onWrite||w,h=null!==(r=y.fast)&&void 0!==r&&r,b=(t=function(){z.value>=Number.MAX_SAFE_INTEGER?(z.value=1,z.usablePrefix+=1):z.value+=1;var e=z.value,r=z.usablePrefix;return"".concat(r,"_").concat(e)}(),n=!1,a=F.autoFreeze,o=!0,u=F.usePatches,c=[],s=[],p={get:function(e,r){var n=e[r];if("__proto__"===r||r===i)return n;if("symbol"==typeof r)return A(n)?n.bind(e):n;var a=N(e),o=null==a?void 0:a.selfType;if(a&&Y.includes(o)&&U.includes(r))return a.copy[r];n=$(n,{key:r,parentMeta:a,parentType:o,ver:t,traps:p,parent:e,patches:c,fast:h,inversePatches:s,usePatches:u});var y=function(){a&&v({keyPath:a.keyPath.concat(r),op:"get",value:n})};return o===f&&S(r)?(y(),n):l[o]?(n=K(e,{op:r,key:r,value:n,metaVer:t,calledBy:"get",patches:c,inversePatches:s,usePatches:u,parentType:o,parentMeta:a}),y(),n):(y(),n)},set:function(e,r,n){var a,u,c=n;if(L(n))if(u=t,j(a=n)&&N(a).ver!==u)o=!1;else if((c=q(n))===e[r])return!0;if(r===i)return e[r]=c,!0;var l=N(e),s=function(){l&&d({keyPath:l.keyPath.concat(r),op:"set",value:n})};if(l&&l.selfType===f){if(l.copy&&l.__callSet&&S(r))return l.copy[r]=c,s(),!0;l.__callSet=!0}return K(e,{parentMeta:l,key:r,value:c,metaVer:t,calledBy:"set"}),s(),!0},deleteProperty:function(e,r){var n=N(e);return K(e,{parentMeta:n,op:"del",key:r,value:"",metaVer:t,calledBy:"deleteProperty"}),d({keyPath:n.keyPath.concat(r),op:"del",value:null}),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(e,r){var o,i,c=r||{};if(a=null!==(o=c.autoFreeze)&&void 0!==o?o:a,u=null!==(i=c.usePatches)&&void 0!==i?i:u,n)throw new Error("can not call new Limu().createDraft twice");var f=e;n=!0,L(e)&&(f=N(e).self);var l=X(f,{key:"",ver:t,traps:p,finishDraft:b.finishDraft});return J(l),l.proxyVal},finishDraft:function(e){var r=N(e);if(!r)throw new Error("oops, rootMeta should not be null!");if(0!==r.level)throw new Error("oops, can not finish sub draft node!");if(t!==r.ver)throw new Error("oops, the input draft does not match finishDraft handler");var n=G(r);return a&&o&&(n=Q(n)),n}});return b}var ee=function(e){var r=Z(e);this.createDraft=r.createDraft,this.finishDraft=r.finishDraft};function re(e,r){return new ee(r).createDraft(e,r)}function te(e){var r=N(e),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function ne(e){if("function"!=typeof e)throw new Error("produce callback is not a function")}function ae(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function");var t}function oe(e,r,t){ne(r);var n=re(e,t),a=r(n);return ae(r,a),te(n)}var ie=N,ue=L,ce=function(e,r,t){if(!r||"function"!=typeof r){var n=e,a=r;return ne(e),function(e){return oe(e,n,a)}}return oe(e,r,t)},fe=Q;var le=function(e,r){if(!L(e))return e;var t=N(e),n=(null==t?void 0:t.self)||null;return r?n:n||null},se=function(e){if(!L(e))return e;var r=N(e);return W(r.copy||r.self)},pe=globalThis;pe.LimuApi||(pe.LimuApi={createDraft:re,finishDraft:te,produce:ce,VER:"3.2.2"}),e.Limu=ee,e.createDraft=re,e.current=se,e.deepCopy=function(e){return W(e)},e.deepFreeze=fe,e.default=ce,e.finishDraft=te,e.getAutoFreeze=function(){return F.autoFreeze},e.getDraftMeta=ie,e.getMajorVer=function(){return 3},e.isDraft=ue,e.original=le,e.produce=ce,e.setAutoFreeze=function(e){F.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
