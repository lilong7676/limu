!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a=function(){return a=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},a.apply(this,arguments)};function o(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}var i="Map",u="Set",f="Array",c={Map:i,Set:u,Array:f},l="[object Object]",s="[object Map]",p="[object Set]",y="[object Array]",d="[object Function]",v=((r={})[s]=i,r[p]=u,r[y]=f,r[l]="Object",r),h=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],b=["clear","delete","set"],m=["add","clear","delete"];o(o([],["entries","keys","values","has"],!0),["size"],!1);o(o([],["entries","has","keys","values"],!0),["size"],!1);var M=((t={})[c.Map]=["clear","delete","entries","forEach","get","has","keys","set","values"],t[c.Set]=["add","clear","delete","entries","forEach","has","keys","values"],t[c.Array]=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),k=((n={})[c.Map]=["forEach","get"],n[c.Set]=["forEach"],n[c.Array]=["forEach","map"],n),g=Object.prototype.toString;function w(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function E(e){return g.call(e)===l}function P(e){return g.call(e)===s}function x(e){return g.call(e)===p}function A(e){return g.call(e)===d}function j(e){var r=g.call(e);return![l,y,s,p,d].includes(r)}function D(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}var O=Symbol("V"),S=Symbol("M"),T=Symbol("limu-finishHandler"),z={value:0,usablePrefix:1},_={autoFreeze:!0,usePatches:!1};function V(e,r){return e[S]=r,e}function F(e){return!j(e)&&!!e[S]}function I(e){var r=B(e);return r?r.level+1:1}function B(e){return e[S]}function N(e){if(!E(e))return e;var r=B(e);return r?r.copy:e}function L(e){var r,t=(r=e,g.call(r));return v[t]}function R(e){if(j(e))return e;if(Array.isArray(e)&&e.length>0)return e.forEach((function(e){R(e)})),Object.freeze(e);if(x(e)){var r=e;return r.add=function(){return r},r.delete=function(){return!1},r.clear=w,Object.freeze(e)}if(P(e)){var t=e;return t.set=function(){return t},t.delete=function(){return!1},t.clear=w,Object.freeze(e)}return Object.getOwnPropertyNames(e).forEach((function(r){var t=e[r];t instanceof Object&&null!==t&&R(t)})),Object.freeze(e)}function W(e){e.rootMeta.modified=!0;var r=function(e){e&&(e.modified=!0,r(e.parentMeta))};r(e)}function C(e,r,t){var n=t.dataType,a=e.delete.bind(e),o=e.clear.bind(e);if(e.delete=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return W(r),a.apply(void 0,e)},e.clear=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return W(r),o.apply(void 0,e)},"Set"===n){var i=e.add.bind(e);e.add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return W(r),i.apply(void 0,e)}}if("Map"===n){var u=e.set.bind(e);e.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return W(r),u.apply(void 0,e)}}}function G(e,r){var t=r.op,n=r.key,a=r.value,o=r.calledBy,i=r.parentType,u=B(e),f=N(a);if(u){var l=u.self,s=u.copy;if(function(e){var r=e.calledBy,t=e.parentDataNodeMeta,n=e.op,a=e.parentType;(["deleteProperty","set"].includes(r)||"get"===r&&("Set"===a&&m.includes(n)||"Array"===a&&h.includes(n)||"Map"===a&&b.includes(n)))&&W(t)}({calledBy:o,parentDataNodeMeta:u,op:t,key:n,parentType:i}),(M[i]||[]).includes(t)&&A(a))return"slice"===t?l.slice:s?i===c.Set||i===c.Map?s[t].bind(s):s[t]:l[t].bind(l);if(!s)return f;if("toJSON"!==t||a)if("deleteProperty"===o){var p=B(a);if(p)p.isDel=!0;else if(e[n]){var y=B(e[n]);y&&(y.isDel=!0)}delete s[n]}else s[n]=f}else e[n]=f}function H(e,r){var t=function(e){if(j(e))return e;if(r){var n=B(e),a=null==n?void 0:n.copy;if(a&&n.level>0)return a}var o=e;if(Array.isArray(e)&&(o=e.slice()).forEach((function(e,r){o[r]=t(e)})),x(e)){var i=Array.from(e);i.forEach((function(e,r){i[r]=t(e)})),o=new Set(i)}return P(e)&&(o=new Map(e)).forEach((function(e,r){o.set(r,t(e))})),E(e)&&(o={},Object.keys(e).forEach((function(r){o[r]=t(e[r])}))),o};return t(e)}function J(e,r){return V(function(e,r){if(Array.isArray(e))return e.slice();if(e&&E(e))return a({},e);if(P(e))return new Map(e);if(x(e))return new Set(e);if(r)throw new Error("make copy err, type can only be object(except null) or array");return e}(e,!0),r)}function X(e){e.rootMeta.scopes.push(e)}var $=["length","constructor","asymmetricMatch","nodeType","size"],q=[f,u,i];function K(){var e,r,t,n,a,l,s,p,y=(e=function(){z.value>=Number.MAX_SAFE_INTEGER?(z.value=1,z.usablePrefix+=1):z.value+=1;var e=z.value,r=z.usablePrefix;return"".concat(r,"_").concat(e)}(),r=!1,t=_.autoFreeze,n=!0,a=_.usePatches,l=[],s=[],p={get:function(r,t){if(t===O)return e;var n=r[t];if("__proto__"===t||t===T||t===S)return n;if("symbol"==typeof t)return A(n)?n.bind(r):n;var f=B(r),y=null==f?void 0:f.selfType;if(f&&q.includes(y)&&$.includes(t))return f.copy[t];var d=function(t,n){if(j(t))return t;if(t){var v=(n||{}).key,h=void 0===v?"":v,b=B(t);if(A(t)){if(function(e,r){return"Array"===e||(k[e]||[]).includes(r)}(y,h)){if(!(b=B(r)))throw new Error("[[ createMeta ]]: oops, meta should not be null");if(!b.proxyItems){var m=[];if(y===u){var M=new Set;r.forEach((function(e){return M.add(d(e))})),C(M,b,{dataType:u,patches:l,inversePatches:s,usePatches:a}),m=V(M,b),f.copy=m}else if(y===i){var g=new Map;r.forEach((function(e,r){return g.set(r,d(e,{key:r}))})),C(g,b,{dataType:i,patches:l,inversePatches:s,usePatches:a}),m=V(g,b),f.copy=m}else y===c.Array&&(b.copy=b.copy||r.slice(),m=b.proxyVal);b.proxyItems=m}}return t}if(!b){var E=(S=[O=h],(T=B(r))&&T.level>0?o(o([],T.keyPath,!0),[O],!1):S),P=B(r),x=J(t,b={rootMeta:null,parentMeta:P,parents:[],parent:P.copy,parentType:y,selfType:L(t),self:t,key:h,keyPath:E,level:I(r),proxyVal:{},copy:{},modified:!1,proxyItems:null,finishDraft:w,ver:e,revoke:w});b.copy=x;var D=Proxy.revocable(x,p);b.proxyVal=D.proxy,b.revoke=D.revoke,b.rootMeta=P.rootMeta,X(b),r[h]=x}return b.proxyVal}var O,S,T;return t};return n=d(n,{key:t}),y===c.Array&&D(t)?n:c[y]?G(r,{op:t,key:t,value:n,metaVer:e,calledBy:"get",patches:l,inversePatches:s,usePatches:a,parentType:y}):n},set:function(r,t,a){var o,i,u=a;if(F(a))if(i=e,E(o=a)&&B(o).ver!==i)n=!1;else if((u=N(a))===r[t])return!0;if(t===S)return r[t]=u,!0;var c=B(r);if(c){if(c.copy&&c.__callSet&&c.selfType===f&&D(t))return c.copy[t]=u,!0;c.__callSet=!0}return G(r,{key:t,value:u,metaVer:e,calledBy:"set"}),!0},deleteProperty:function(r,t){return G(r,{op:"del",key:t,value:"",metaVer:e,calledBy:"deleteProperty"}),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(n,o){var i,u,f=o||{};if(t=null!==(i=f.autoFreeze)&&void 0!==i?i:t,a=null!==(u=f.usePatches)&&void 0!==u?u:a,r)throw new Error("can not call new Limu().createDraft twice");var c=n;r=!0,F(n)&&(c=B(n).self);var l=L(c),s={rootMeta:null,parent:null,parentMeta:null,parents:[],parentType:l,selfType:l,self:c,copy:null,modified:!1,key:"",keyPath:[],level:0,proxyVal:null,proxyItems:null,scopes:[],finishDraft:y.finishDraft,ver:e},d=J(c,s);s.copy=d,s.rootMeta=s;var v=Proxy.revocable(d,p),h=v.proxy,b=v.revoke;return s.proxyVal=h,s.revoke=b,X(s),h},finishDraft:function(r){var a=B(r);if(!a)throw new Error("oops, rootMeta should not be null!");if(e!==a.ver)throw new Error("oops, the input draft does not match finishDraft handler");var o=a.self,c=a.copy,l=a.modified,s=o;return c&&l&&(s=a.copy),function(e){e.scopes.forEach((function(e){var r=e.modified,t=e.copy,n=e.parentMeta,a=e.key,o=e.self,c=e.parentType,l=e.revoke,s=e.proxyVal,p=e.isDel;if(!t)return l();if(delete t[S],!n)return l();var y=r?t:o,d=n.copy;return c===i?(d.set(a,y),l()):c===u?(d.delete(s),d.add(y),l()):c===f||!0!==p?(d[a]=y,l()):void 0})),e.scopes.length=0}(a),t&&n&&(s=R(s)),s}});return y}var Q=function(){var e=K();this.createDraft=e.createDraft,this.finishDraft=e.finishDraft};function U(e,r){return(new Q).createDraft(e,r)}function Y(e){var r=B(e),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function Z(e){if("function"!=typeof e)throw new Error("produce callback is not a function")}function ee(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function");var t}function re(e,r,t){Z(r);var n=U(e,t),a=r(n);return ee(r,a),Y(n)}var te=B,ne=F,ae=function(e,r,t){if(!r||"function"!=typeof r){var n=e,a=r;return Z(e),function(e){return re(e,n,a)}}return re(e,r,t)},oe=R;var ie=function(e,r){if(!F(e))return e;var t=B(e),n=(null==t?void 0:t.self)||null;return r?n:n||null},ue=function(e){if(!F(e))return e;var r=B(e);return H(r.copy||r.self)};e.Limu=Q,e.createDraft=U,e.current=ue,e.deepCopy=function(e){return H(e)},e.deepFreeze=oe,e.default=ae,e.finishDraft=Y,e.getAutoFreeze=function(){return _.autoFreeze},e.getDraftMeta=te,e.getMajorVer=function(){return 3},e.isDraft=ne,e.original=ie,e.produce=ae,e.setAutoFreeze=function(e){_.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
