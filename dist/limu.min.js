!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a,o=function(){return o=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},o.apply(this,arguments)};function i(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}var f={Map:"Map",Set:"Set",Array:"Array"},l="[object Object]",u="[object Map]",c="[object Set]",p="[object Array]",s="[object Function]",y=((r={})[u]=f.Map,r[c]=f.Set,r[p]=f.Array,r[l]="Object",r),d=["length","slice","concat","find","findIndex","filter","flat","flatMap","includes","indexOf","every","some","constructor","join","keys","lastIndexOf","reduce","reduceRight","values","entries","valueOf"],v=i(i([],["entries","keys","values","has"],!0),["size"],!1),h=i(i([],["entries","has","keys","values"],!0),["size"],!1),m=((t={})[f.Map]=["clear","delete","entries","forEach","get","has","keys","set","values"],t[f.Set]=["add","clear","delete","entries","forEach","has","keys","values"],t[f.Array]=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),M=((n={})[f.Map]=["clear","delete","set"],n[f.Set]=["add","clear","delete"],n[f.Array]=["copyWithin","fill","pop","push","reverse","shift","unshift","splice"],n),b=((a={})[f.Map]=["forEach","get"],a[f.Set]=["forEach"],a[f.Array]=["forEach","map"],a),x=Object.prototype.toString;function _(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function g(e){return x.call(e)===l}function S(e){return x.call(e)===u}function w(e){return x.call(e)===c}function A(e){return x.call(e)===s}function E(e){var r=x.call(e);return![l,p,u,c,s].includes(r)}function O(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}function k(e){return"symbol"==typeof e}var I=Symbol("verKey"),j=Symbol("metas"),D=Symbol("finishHandler"),T=Symbol("isModifiedKey"),P={},V={value:0};function B(e,r,t){var n=[r],a=z(e,t);return a&&a.level>0?i(i([],a.keyPath,!0),[r],!1):n}function z(e,r){var t=N(e);return t?t[r]:null}function L(e,r){return e?z(e.__proto__,r):null}function N(e){return e?e[j]:null}function W(e,r){var t=e.self;if(Array.isArray(t))return e.proxyItems||t.slice();if(g(t))return o({},t);if(S(t))return e.proxyItems||r||new Map(t);if(w(t))return e.proxyItems||r||new Set(t);throw new Error("data ".concat(t," try trigger getCopy, its type is ").concat(typeof e))}function F(e){return Array.isArray(e)?e.slice():e&&g(e)?o({},e):S(e)?new Map(e):w(e)?new Set(e):e}function K(e,r,t){var n=N(e);n&&(n[t]=r)}function R(e,r){var t=z(e,r);return t?t.level+1:1}function C(e){return Object.getPrototypeOf(e)?Object.getPrototypeOf(e):Object.prototype}function H(e,r){var t=Object.create(null);Object.setPrototypeOf(t,r),Object.setPrototypeOf(e,t),e.__proto__[j]={}}function J(e){return!!(null==e?void 0:e[I])}function $(e){var r,t=(r=e,x.call(r));return y[t]}function q(e,r,t){var n,a=e.parentMeta,o=e.parentType,i=e.selfType,f=e.idx,l=e.copy;if("set"===r&&O(t)&&"Array"===i){var u=e.proxyItems;u&&(u[T]=!0)}if(a){var c=a.copy;c||(c=W(a),a.copy=c);var p=!1;"Map"===o?(c.set(f,l),p=!0):"Object"===o?c[f]=l:"Array"===o?(c[f]=l,p=!0):"Set"===o&&(p=!0);var s=a.proxyItems;p&&s&&(s[T]=!0,s.__parent=null===(n=a.parentMeta)||void 0===n?void 0:n.copy,s.__dataIndex=a.idx)}}function G(e,r,t){if(null==e?void 0:e.rootMeta){e.rootMeta.modified=!0;var n=z(r,t);n&&q(n)}}function Q(e,r,t,n,a){var o=r.delete.bind(r),i=r.clear.bind(r);if(r.add=function(){_()},r.set=function(){_()},r.delete=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return G(t,n,a),o.apply(void 0,e)},r.clear=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return G(t,n,a),i.apply(void 0,e)},"Set"===e){var f=r.add.bind(r);r.add=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return G(t,n,a),f.apply(void 0,e)}}if("Map"===e){var l=r.set.bind(r);r.set=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return G(t,n,a),l.apply(void 0,e)}}}var U=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],X=["clear","delete","set"],Y=["add","clear","delete"];function Z(e,r,t){var n=r.op,a=r.key,o=r.value,i=r.metaVer,l=r.calledBy,u=r.parentType,c=z(e,i),p=o;if(t&&(p=function(e,r){var t=L(e,r);if(!t)return e;var n=t.copy;return n||(n=W(t),t.copy=n),n}(o,i)),c){var s=c.self,y=c.rootMeta,b=c.copy,x=function(e,r){if(e===f.Array){if(d.includes(r))return!1;if(O(r))return!1}return!(e===f.Map&&v.includes(r)||e===f.Set&&h.includes(r)||k(r))}(u,n);if(x){if(b&&!["Map","Set"].includes(u)||(b=W(c,b),c.copy=b),!E(p)){var _=z(o,i);_&&_.parentMeta&&_.parentMeta.level!==c.level&&(_.parent=c.self,_.level=c.level+1,_.key=a,_.keyPath=B(_.parent,a,i))}!function(e){var r=e.calledBy,t=e.parentDataNodeMeta,n=e.op,a=e.parentType,o=e.key;(["deleteProperty","set"].includes(r)||"get"===r&&("Set"===a&&Y.includes(n)||"Array"===a&&U.includes(n)||"Map"===a&&X.includes(n)))&&q(t,r,o)}({calledBy:l,parentDataNodeMeta:c,op:n,key:a,parentType:u});var g=c.parentMeta;if(g){var S={key:c.key,parentType:c.parentType,value:b,metaVer:i,calledBy:l};Z(g.self,S,!1)}}var w=function(){c.modified=!0,y&&(y.modified=!0)};if((m[u]||[]).includes(n)&&A(o))return M[u].includes(n)&&w(),"slice"===n?s.slice:b?u===f.Set||u===f.Map?b[n].bind(b):["map","sort"].includes(n)?b[n].bind(c.proxyVal):b[n].bind(c.proxyItems):s[n].bind(s);if(!b)return p;if(t)if("del"===n)delete b[a];else{if("toJSON"===n&&!o)return;b[a]=p}["set","deleteProperty"].includes(l)&&w()}else e[a]=p}function ee(e,r,t){void 0===t&&(t=!1);var n=function(e){return!E(e)}(e);if(n){var a=e[j];return a||(H(e,C(e)),a=e[j]),void P[r].push(a)}if(t)throw new Error("base state type can only be object(except null) or array")}function re(e,r){var t=e[j];t||(H(e,C(e)),t=e[j]),P[r].push(t)}var te=["length","constructor","asymmetricMatch","nodeType","size"],ne=[f.Array,f.Set,f.Map],ae=[f.Set,f.Map],oe=function(e,r,t){var n=e.proxyItemsMgr.Map,a=null;return n.forEach((function(e){if(e[T]){var t=new Map;a=t,e.forEach((function(e,n){var a=z(e,r);if(a){var o=a.modified?a.copy:a.self;t.set(n,o)}})),e.__parent&&(e.__parent[e.__dataIndex]=t)}})),"Map"===e.parentType&&a||t},ie=function(e,r,t){var n=e.proxyItemsMgr.Set,a=null;return n.forEach((function(e){if(e[T]){var t=Array.from(e);a=t,t.forEach((function(e,n){var a=z(e,r);a&&(t[n]=a.modified?a.copy:a.self)})),e.__parent&&(e.__parent[e.__dataIndex]=new Set(t))}})),"Set"===e.parentType&&a?new Set(a):t},fe=function(e,r,t){var n=e.proxyItemsMgr.Array,a=[];return n.forEach((function(e){if(e[T]){var t=z(e,r),n=(null==t?void 0:t.copy)||e;n.forEach((function(e,t){var n=z(e,r);a[t]=n?n.modified?n.copy:n.self:e}));var o=n.__parent;o&&(o[n.__dataIndex]=a)}})),"Array"===e.parentType&&a.length?a:t};function le(){var e,r,t,n,a=(e=function(){V.value+=1;var e=V.value;return P[e]=[],e}(),r=!1,t=null,n={get:function(r,t){if(t===I)return e;var a=r[t];if("__proto__"===t||t===D||t===T)return a;if(k(t))return A(a)?a.bind(r):a;var o=$(r),i=z(r,e);if(i&&ne.includes(o)&&te.includes(t))return i.copy?i.copy[t]:i.self[t];if(i){var l=i.self,u=i.copy,c=l[t];if(!ae.includes(o)&&(_(j,re),u&&(a=u[t]),c!==a)){if(Array.isArray(c)&&Array.isArray(a)&&i&&!a[j]){var p=z(r[t],e);if(p)return re(a,e),K(a,p,e),p.proxyVal}return a}}var s=function(a,i,l){var u,c;if(void 0===l&&(l=-1),a&&!E(a)){var p=z(a,e);if(A(a)){if(function(e,r){return"Array"===e||(b[e]||[]).includes(r)}(o,t)){if(!(p=z(r,e)))throw new Error("[[ createMeta ]]: oops, meta should not be null");if(!p.proxyItems){var y=[];if(o===f.Set){var d=new Set;r.forEach((function(e){return d.add(s(e,F(e)))})),Q("Set",d,p,r,e),y=d}else if(o===f.Map){var v=new Map;r.forEach((function(e,r){return v.set(r,s(e,F(e),r))})),Q("Map",v,p,r,e),y=v}else if(o===f.Array){var h=[],m=p.copy||r;p.copy=h,m.forEach((function(e,r){return h.push(s(e,F(e),r))})),y=p.proxyVal}p.proxyItems=y;var M=null===(c=null===(u=p.rootMeta)||void 0===u?void 0:u.proxyItemsMgr)||void 0===c?void 0:c[o];M&&M.push(y)}}return a}if(ee(a,e),!p){p={rootMeta:null,parentMeta:null,parent:r,parentType:o,selfType:$(a),self:a,key:t,idx:l,keyPath:B(r,l,e),level:R(r,e),proxyVal:new Proxy(a,n),copy:i,modified:!1,proxyItems:null,proxyItemsMgr:null,finishDraft:_,ver:e};var x=z(r,e);x&&(p.parentMeta=x,p.rootMeta=x.rootMeta),K(a,p,e)}return p.proxyVal}return a};return a=s(a,null,t),o===f.Array&&O(t)?a:f[o]?Z(r,{parentType:o,op:t,key:t,value:a,metaVer:e,calledBy:"get"},!0):a},set:function(r,t,n){if(t===T)return r.__proto__[T]=n,!0;var a=z(r,e);if(a){if(a.copy&&a.__callSet&&a.selfType===f.Array&&O(t))return a.copy[t]=n,!0;a.__callSet=!0}return Z(r,{key:t,value:n,metaVer:e,calledBy:"set"},!0),!0},deleteProperty:function(r,t){return Z(r,{op:"del",key:t,value:"",metaVer:e,calledBy:"deleteProperty"},!0),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(o){if(r)throw new Error("can not call new Limu().createDraft twice");var i=o;r=!0,J(o)&&(i=L(o,o[I]).self),ee(i,e,!0);var f=z(i,e);if(!f){var l=$(i);(f={rootMeta:null,parent:null,parentMeta:null,parentType:l,selfType:l,self:i,copy:null,modified:!1,key:"",keyPath:[],idx:-1,level:0,proxyVal:null,proxyItems:null,proxyItemsMgr:{Map:[],Set:[],Array:[]},finishDraft:a.finishDraft,ver:e}).rootMeta=f,K(i,f,e)}var u=Proxy.revocable(i,n),c=u.proxy,p=u.revoke;return f.proxyVal=c,t=p,c},finishDraft:function(r){if(e!==r[I])throw new Error("oops, the input draft does not match finishDraft handler");var n=L(r,e);if(!n)throw new Error("oops, rootMeta should not be null!");var a=n.self;return n.copy&&n.modified&&(a=n.copy,a=oe(n,e,a),a=ie(n,e,a),a=fe(n,e,a)),t&&t(),function(e){P[e].forEach((function(r){return delete r[e]}))}(e),a}});return a}var ue=function(){var e=le();this.createDraft=e.createDraft,this.finishDraft=e.finishDraft};function ce(e){return(new ue).createDraft(e)}function pe(e){var r=L(e,e[I]),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function se(e){if("function"!=typeof e)throw new Error("produce callback is not a function")}function ye(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function");var t}function de(e,r){se(r);var t=ce(e),n=r(t);return ye(r,n),pe(t)}var ve=J,he=function(e,r){return r?de(e,r):(se(e),function(r){return de(r,e)})};e.Limu=ue,e.createDraft=ce,e.finishDraft=pe,e.getDraftMeta=function(e){return L(e,e[I])},e.isDraft=ve,e.produce=he,Object.defineProperty(e,"__esModule",{value:!0})}));
