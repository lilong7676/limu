!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a=function(){return a=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},a.apply(this,arguments)};function o(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}var i="Map",u="Set",c="Array",f={Map:i,Set:u,Array:c},l="[object Object]",s="[object Map]",p="[object Set]",v="[object Array]",y="[object Function]",d=((r={})[s]=i,r[p]=u,r[v]=c,r[l]="Object",r),h=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],b=["clear","delete","set"],M=["add","clear","delete"];o(o([],["entries","keys","values","has"],!0),["size"],!1);o(o([],["entries","has","keys","values"],!0),["size"],!1);var m=((t={})[f.Map]=["clear","delete","entries","forEach","get","has","keys","set","values"],t[f.Set]=["add","clear","delete","entries","forEach","has","keys","values"],t[f.Array]=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),k=((n={})[f.Map]=["forEach","get"],n[f.Set]=["forEach"],n[f.Array]=["forEach","map"],n),w=Object.prototype.toString;function P(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function g(e){return w.call(e)===l}function E(e){return w.call(e)===s}function D(e){return w.call(e)===p}function j(e){return w.call(e)===y}function x(e){var r,t=(r=e,w.call(r));return d[t]}function A(e){var r=w.call(e);return![l,v,s,p,y].includes(r)}function O(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}var T=Symbol("M"),z={value:0,usablePrefix:1},S={autoFreeze:!0,usePatches:!1};function _(e){e.rootMeta.modified=!0;var r=function(e){e&&(e.modified=!0,r(e.parentMeta))};r(e)}function F(e,r){return e[T]=r,e}function V(e,r){var t=r.finishDraft,n=r.ver,a=r.parentMeta,i=void 0===a?null:a,u=r.key,c=x(e),f=[],l=0,s=null;i&&(l=function(e){var r=I(e);return r?r.level+1:1}(s=i.copy),f=function(e,r){var t=[r],n=I(e);return n&&n.level>0?o(o([],n.keyPath,!0),[r],!1):t}(s,u));var p={rootMeta:null,parentMeta:i,parent:s,selfType:c,self:e,copy:null,key:u,keyPath:f,level:l,proxyVal:null,proxyItems:null,modified:!1,scopes:[],finishDraft:t,ver:n,revoke:P};return p.rootMeta=0===l?p:i.rootMeta,p}function B(e){return!A(e)&&!!e[T]}function I(e){return e[T]}function N(e,r){var t=function(e){if(A(e))return e;if(r){var n=I(e),a=null==n?void 0:n.copy;if(a&&n.level>0)return a}var o=e;if(Array.isArray(e)&&(o=e.slice()).forEach((function(e,r){o[r]=t(e)})),D(e)){var i=Array.from(e);i.forEach((function(e,r){i[r]=t(e)})),o=new Set(i)}return E(e)&&(o=new Map(e)).forEach((function(e,r){o.set(r,t(e))})),g(e)&&(o={},Object.keys(e).forEach((function(r){o[r]=t(e[r])}))),o};return t(e)}function L(e,r){return F(function(e,r){if(Array.isArray(e))return e.slice();if(e&&g(e))return a({},e);if(E(e))return new Map(e);if(D(e))return new Set(e);if(r)throw new Error("make copy err, type can only be object(except null) or array");return e}(e,!0),r)}function R(e){var r=e.self,t=e.copy,n=e.modified,a=r;return t&&n&&(a=e.copy),function(e){e.scopes.forEach((function(e){var r=e.modified,t=e.copy,n=e.parentMeta,a=e.key,o=e.self,f=e.revoke,l=e.proxyVal,s=e.isDel;if(!t)return f();if(delete t[T],!n)return f();var p=r?t:o,v=n.copy,y=n.selfType;return y===i?(v.set(a,p),f()):y===u?(v.delete(l),v.add(p),f()):y===c||!0!==s?(v[a]=p,f()):void 0})),e.scopes.length=0}(e),a}function W(e){e.rootMeta.scopes.push(e)}function C(e,r){var t=r.finishDraft,n=void 0===t?P:t,a=r.ver,o=r.traps,i=V(e,{finishDraft:n,ver:a,parentMeta:r.parentMeta,key:r.key}),u=L(e,i);i.copy=u;var c=Proxy.revocable(u,o);return i.proxyVal=c.proxy,i.revoke=c.revoke,i}function G(e,r){var t=r||{},n=t.key,a=t.parentMeta,o=t.ver,f=t.traps,l=t.parent,s=t.patches,p=t.inversePatches,v=t.usePatches,y=t.parentType,d=function(e,r){if(A(e)||!e)return e;var t=r||"",n=I(e);if(!j(e))return n||(W(n=C(e,{key:t,parentMeta:a,ver:o,traps:f})),l[t]=n.copy),n.proxyVal;if(!function(e,r){return e===c||(k[e]||[]).includes(r)}(y,t))return e;if(!a)throw new Error("[[ createMeta ]]: oops, meta should not be null");if(a.proxyItems)return e;var h=[];if(y===u){var b=new Set;l.forEach((function(e){return b.add(d(e))})),X(b,a,{dataType:u,patches:s,inversePatches:p,usePatches:v}),h=F(b,a),a.copy=h}else if(y===i){var M=new Map;l.forEach((function(e,r){return M.set(r,d(e,r))})),X(M,a,{dataType:i,patches:s,inversePatches:p,usePatches:v}),h=F(M,a),a.copy=h}else y===c&&(a.copy=a.copy||l.slice(),h=a.proxyVal);return a.proxyItems=h,e};return d(e,n)}function J(e){if(!g(e))return e;var r=I(e);return r?r.copy:e}function X(e,r,t){var n=t.dataType,a=e.delete.bind(e),o=e.clear.bind(e);if(e.delete=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return _(r),a.apply(void 0,e)},e.clear=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return _(r),o.apply(void 0,e)},n===u){var c=e.add.bind(e);e.add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return _(r),c.apply(void 0,e)}}if(n===i){var f=e.set.bind(e);e.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return _(r),f.apply(void 0,e)}}}function $(e,r){var t=r.op,n=r.key,a=r.value,o=r.calledBy,f=r.parentType,l=r.parentMeta;if("toJSON"!==t||a){var s=J(a);if(l){var p=l.self,v=l.copy;if(function(e){var r=e.calledBy,t=e.parentMeta,n=e.op,a=e.parentType;(["deleteProperty","set"].includes(r)||"get"===r&&(a===u&&M.includes(n)||a===c&&h.includes(n)||a===i&&b.includes(n)))&&_(t)}({calledBy:o,parentMeta:l,op:t,key:n,parentType:f}),(m[f]||[]).includes(t)&&j(a))return"slice"===t?p.slice:v?f===u||f===i?v[t].bind(v):v[t]:p[t].bind(p);if(!v)return s;var y=v[n],d=function(){if(y){var e=I(y);e&&(e.isDel=!0)}};if("deleteProperty"===o){var k=I(a);return k?k.isDel=!0:d(),void delete v[n]}v[n]=s,d()}else e[n]=s}}function q(e){if(A(e))return e;if(Array.isArray(e)&&e.length>0)return e.forEach((function(e){q(e)})),Object.freeze(e);if(D(e)){var r=e;return r.add=function(){return r},r.delete=function(){return!1},r.clear=P,Object.freeze(e)}if(E(e)){var t=e;return t.set=function(){return t},t.delete=function(){return!1},t.clear=P,Object.freeze(e)}return Object.getOwnPropertyNames(e).forEach((function(r){var t=e[r];t instanceof Object&&null!==t&&q(t)})),Object.freeze(e)}var H=["length","constructor","asymmetricMatch","nodeType","size"],K=[c,u,i];function Q(){var e,r,t,n,a,o,i,u,l=(e=function(){z.value>=Number.MAX_SAFE_INTEGER?(z.value=1,z.usablePrefix+=1):z.value+=1;var e=z.value,r=z.usablePrefix;return"".concat(r,"_").concat(e)}(),r=!1,t=S.autoFreeze,n=!0,a=S.usePatches,o=[],i=[],u={get:function(r,t){var n=r[t];if("__proto__"===t||t===T)return n;if("symbol"==typeof t)return j(n)?n.bind(r):n;var l=I(r),s=null==l?void 0:l.selfType;return l&&K.includes(s)&&H.includes(t)?l.copy[t]:(n=G(n,{key:t,parentMeta:l,parentType:s,ver:e,traps:u,parent:r,patches:o,inversePatches:i,usePatches:a}),s===c&&O(t)?n:f[s]?n=$(r,{op:t,key:t,value:n,metaVer:e,calledBy:"get",patches:o,inversePatches:i,usePatches:a,parentType:s,parentMeta:l}):n)},set:function(r,t,a){var o,i,u=a;if(B(a))if(i=e,g(o=a)&&I(o).ver!==i)n=!1;else if((u=J(a))===r[t])return!0;if(t===T)return r[t]=u,!0;var f=I(r),l=f.selfType===c;if(f&&l){if(f.copy&&f.__callSet&&l&&O(t))return f.copy[t]=u,!0;f.__callSet=!0}return $(r,{parentMeta:f,key:t,value:u,metaVer:e,calledBy:"set"}),!0},deleteProperty:function(r,t){return $(r,{parentMeta:I(r),op:"del",key:t,value:"",metaVer:e,calledBy:"deleteProperty"}),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(n,o){var i,c,f=o||{};if(t=null!==(i=f.autoFreeze)&&void 0!==i?i:t,a=null!==(c=f.usePatches)&&void 0!==c?c:a,r)throw new Error("can not call new Limu().createDraft twice");var s=n;r=!0,B(n)&&(s=I(n).self);var p=C(s,{key:"",ver:e,traps:u,finishDraft:l.finishDraft});return W(p),p.proxyVal},finishDraft:function(r){var a=I(r);if(!a)throw new Error("oops, rootMeta should not be null!");if(0!==a.level)throw new Error("oops, can not finish sub draft node!");if(e!==a.ver)throw new Error("oops, the input draft does not match finishDraft handler");var o=R(a);return t&&n&&(o=q(o)),o}});return l}var U=function(){var e=Q();this.createDraft=e.createDraft,this.finishDraft=e.finishDraft};function Y(e,r){return(new U).createDraft(e,r)}function Z(e){var r=I(e),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function ee(e){if("function"!=typeof e)throw new Error("produce callback is not a function")}function re(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function");var t}function te(e,r,t){ee(r);var n=Y(e,t),a=r(n);return re(r,a),Z(n)}var ne=I,ae=B,oe=function(e,r,t){if(!r||"function"!=typeof r){var n=e,a=r;return ee(e),function(e){return te(e,n,a)}}return te(e,r,t)},ie=q;var ue=function(e,r){if(!B(e))return e;var t=I(e),n=(null==t?void 0:t.self)||null;return r?n:n||null},ce=function(e){if(!B(e))return e;var r=I(e);return N(r.copy||r.self)};e.Limu=U,e.createDraft=Y,e.current=ce,e.deepCopy=function(e){return N(e)},e.deepFreeze=ie,e.default=oe,e.finishDraft=Z,e.getAutoFreeze=function(){return S.autoFreeze},e.getDraftMeta=ne,e.getMajorVer=function(){return 3},e.isDraft=ae,e.original=ue,e.produce=oe,e.setAutoFreeze=function(e){S.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
