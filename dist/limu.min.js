!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";const t=Symbol("M"),r=Symbol("IMMUT_BASE"),n="Map",o="Set",a="Array",s={Map:n,Set:o,Array:a},i="[object Object]",c="[object Map]",u="[object Set]",f="[object Array]",l="[object Function]",p={[c]:n,[u]:o,[f]:a,[i]:"Object"},y=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],d=["set","clear","delete"],h=["add","clear","delete"],m=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],v={[n]:["clear","delete","entries","forEach","get","has","keys","set","values"],[o]:["add","clear","delete","entries","forEach","has","keys","values"],[a]:m},b={[n]:["clear","set","delete"],[o]:["clear","add","delete"],[a]:m},M={[n]:["forEach","get"],[o]:["forEach"],[a]:["forEach","map"]},P={value:0,usablePrefix:1},O={autoFreeze:!1,usePatches:!1,fastModeRange:"array"},g=Object.prototype.toString;function k(e){return g.call(e)}function j(...e){return e}function x(e){return k(e)===i}function E(e){return k(e)===c}function T(e){return k(e)===u}function w(e){return k(e)===l}function D(e){const t=k(e);return![i,f,c,u,l].includes(t)}function _(e){return"AsyncFunction"===e.constructor.name||"function"==typeof e.then}function B(e){return"undefined"!=typeof Promise&&e instanceof Promise}function A(e){var t=typeof e;return"number"===t||"string"===t&&/^[0-9]*$/.test(e)}function F(e){return"symbol"==typeof e}const S={[f]:Array.prototype,[c]:Map.prototype,[u]:Set.prototype,[l]:Function.prototype};function z(e){e.rootMeta.modified=!0;const t=e=>{e&&!e.modified&&(e.modified=!0,t(e.parentMeta))};t(e)}function R(e,r,n,o){return n?e[t]=r:(!function(e,t){const r=k(e),n=S[r]||Object.prototype,o=Object.create(null);t&&Object.assign(o,t),Object.setPrototypeOf(o,n),Object.setPrototypeOf(e,o)}(e,o),e.__proto__[t]=r),e}function I(e,t){const{finishDraft:r,ver:n,parentMeta:o=null,key:a,immutBase:s}=t,i=(c=k(e),p[c]);var c;let u=[],f=0,l=null;o&&(l=o.copy,f=function(e){const t=C(e);return t?t.level+1:1}(l),u=function(e,t){const r=[t],n=N(e);if(n&&n.level>0){const{keyPath:e}=n;return[...e,t]}return r}(l,a));const y={rootMeta:null,parentMeta:o,parent:l,selfType:i,self:e,copy:null,key:a,keyPath:u,level:f,proxyVal:null,proxyItems:null,modified:!1,scopes:[],isImmutBase:s,isDel:!1,isFast:!1,linkCount:1,finishDraft:r,ver:n,revoke:j};return y.rootMeta=0===f?y:o.rootMeta,y}function V(e){if(D(e))return!1;const t=C(e);return!!t&&!t.isImmutBase}function N(e){return e[t]}function C(e){return e&&e[t]||null}function $(e,t){if(D(e)&&D(t))return e!==t;const r=C(e),n=C(t);if(!r&&!n)return e!==t;const{self:o,modified:a}=r||{self:e,modified:!1},{self:s,modified:i}=n||{self:t,modified:!1};return o!==s||(a||i)}function K(e){const t=e=>{if(D(e))return e;let r=e;if(Array.isArray(e)&&(r=e.slice(),r.forEach(((e,n)=>{r[n]=t(e)}))),T(e)){const n=Array.from(e);n.forEach(((e,r)=>{n[r]=t(e)})),r=new Set(n)}return E(e)&&(r=new Map(e),r.forEach(((e,n)=>{r.set(n,t(e))}))),x(e)&&(r={},Object.keys(e).forEach((n=>{r[n]=t(e[n])}))),r};return t(e)}function U(e,t,r){const{extraProps:n}=r,{copy:o,fast:s}=function(e,t){const{parentType:r,fastModeRange:n}=t;if(Array.isArray(e))return{copy:e.slice(),fast:!1};const o="array"===n&&r===a||"all"===n;let s=e;return e&&x(e)&&(s=Object.assign({},e)),E(e)&&(s=new Map(e)),T(e)&&(s=new Set(e)),{copy:s,fast:o}}(e,r);return R(o,t,s,n),{copy:o,fast:s}}function W(e){const{self:r,copy:s,modified:i}=e;let c=r;return s&&i&&(c=e.copy),function(e){e.scopes.forEach((e=>{const{modified:r,copy:s,parentMeta:i,key:c,self:u,revoke:f,proxyVal:l,isDel:p,isFast:y}=e;if(!s)return f();if(y?delete s[t]:delete s.__proto__[t],!i)return f();const d=r?s:u,h=i.copy,m=i.selfType;return m===n?(h.set(c,d),f()):m===o?(h.delete(l),h.add(d),f()):m===a||!0!==p?(h[c]=d,f()):void 0})),e.scopes.length=0}(e),c}function G(e){e.rootMeta.scopes.push(e)}function J(e,t){const{finishDraft:r=j,ver:n,traps:o,parentType:a,parentMeta:s,key:i,fastModeRange:c,immutBase:u,extraProps:f}=t,l=I(e,{finishDraft:r,ver:n,parentMeta:s,key:i,immutBase:u}),{copy:p,fast:y}=U(e,l,{parentType:a,fastModeRange:c,extraProps:f});if(l.copy=p,l.isFast=y,u){const e=new Proxy(p,o);l.proxyVal=e,l.revoke=j}else{const e=Proxy.revocable(p,o);l.proxyVal=e.proxy,l.revoke=e.revoke}return l}function L(e,t){const{key:r,parentMeta:s,ver:i,traps:c,parent:u,patches:f,inversePatches:l,usePatches:p,parentType:y,fastModeRange:d,immutBase:h,readOnly:m,extraProps:v}=t;let b=e;if(m&&s&&!w(e)){const{copy:e,self:t}=s,n=t[r];e[r]=n,b=n}const P=(e,t)=>{const r=t||"";if(D(e)||!e)return e;if(!s)throw new Error("[[ createMeta ]]: meta should not be null");if(!w(e)){let t=N(e);return t||(t=J(e,{key:r,parentMeta:s,parentType:y,ver:i,traps:c,fastModeRange:d,immutBase:h,readOnly:m,extraProps:v}),G(t),u[r]=t.copy),t.proxyVal}if(!function(e,t){return e===a||(M[e]||[]).includes(t)}(y,r))return e;if(s.proxyItems)return e;let b=[];if(y===o){const e=new Set;u.forEach((t=>e.add(P(t)))),q(e,s,{dataType:o,patches:f,inversePatches:l,usePatches:p}),b=R(e,s,d,v),s.copy=b}else if(y===n){const e=new Map;u.forEach(((t,r)=>e.set(r,P(t,r)))),q(e,s,{dataType:n,patches:f,inversePatches:l,usePatches:p}),b=R(e,s,d,v),s.copy=b}else y===a&&"sort"!==r&&(s.copy=s.copy||u.slice(),b=s.proxyVal);return s.proxyItems=b,e};return P(b,r)}function X(e){if(!x(e))return e;const t=N(e);return t?t.copy:e}function q(e,t,r){const{dataType:a}=r,s=e.delete.bind(e),i=e.clear.bind(e);if(e.delete=function(...e){return z(t),s(...e)},e.clear=function(...e){return z(t),i(...e)},a===o){const n=e.add.bind(e);e.add=function(...e){return z(t),Object.assign({meta:t},r),n(...e)}}if(a===n){const n=e.set.bind(e);e.set=function(...e){return z(t),Object.assign({meta:t},r),n(...e)}}}function H(e,t){const{op:r,key:s,value:i,calledBy:c,parentType:u,parentMeta:f}=t,l=X(i);if(!f)return void(e[s]=l);const{self:p,copy:m}=f;!function(e){const{calledBy:t,parentMeta:r,op:s,parentType:i}=e;(["deleteProperty","set"].includes(t)||"get"===t&&(i===o&&h.includes(s)||i===a&&y.includes(s)||i===n&&d.includes(s)))&&z(r)}({calledBy:c,parentMeta:f,op:r,key:s,parentType:u});if((v[u]||[]).includes(r)&&w(i))return"slice"===r?p.slice:m?u===o||u===n?m[r].bind(m):m[r]:p[r].bind(p);if(!m)return l;const b=m[s],M=()=>{const e=C(b);e&&(e.isDel=!0)};if("deleteProperty"===c){const e=C(i);return e?e.isDel=!0:M(),void delete m[s]}m[s]=l,M(),(()=>{const e=C(i);e&&e.isDel&&(e.isDel=!1,e.key=s,e.keyPath=f.keyPath.concat([s]),e.level=f.level+1,e.parent=f.copy,e.parentMeta=f)})()}function Q(e){if(D(e))return e;if(Array.isArray(e)&&e.length>0)return e.forEach(Q),Object.freeze(e);if(T(e)){const t=e;t.add=()=>t,t.delete=()=>!1,t.clear=j;for(const e of t.values())Object.freeze(e);return Object.freeze(e)}if(E(e)){const t=e;t.set=()=>t,t.delete=()=>!1,t.clear=j;for(const e of t.values())Object.freeze(e);return Object.freeze(e)}return Object.getOwnPropertyNames(e).forEach((t=>{Q(e[t])})),Object.freeze(e)}const Y=["length","constructor","asymmetricMatch","nodeType","size"],Z=[a,o,n];function ee(){return console.error("can not mutate state at readOnly mode!"),!0}function te(e){var n,o,i,c;const u=e||{},f=u.onOperate,l=u.fastModeRange||O.fastModeRange,p=null!==(n=u[r])&&void 0!==n&&n,y=u.extraProps||null,d=null!==(o=u.readOnly)&&void 0!==o&&o,h=null!==(i=u.autoFreeze)&&void 0!==i?i:O.autoFreeze,m=null!==(c=u.usePatches)&&void 0!==c?c:O.usePatches,M=(e,t,r)=>{if(!r||!f)return;const{selfType:n,keyPath:o,self:a,copy:s}=r;let i="get"!==e,c=!1;if((v[n]||[]).includes(t)){c=!0;i=(b[n]||[]).includes(t)}f({parentType:n,op:e,isBuiltInFnKey:c,isChange:i,key:t,keyPath:o,fullKeyPath:o.concat(t),value:s[t]||a[t]})},g=(()=>{const e=function(){P.value>=Number.MAX_SAFE_INTEGER?(P.value=1,P.usablePrefix+=1):P.value+=1;const{value:e,usablePrefix:t}=P;return`${t}_${e}`}();let r=!0;const n=[],o=[],i={get:(r,c)=>{let u=r[c];if("toJSON"===c&&Array.isArray(r))return u;if("__proto__"===c||c===t)return u;if(F(c))return w(u)?u.bind(r):u;const f=N(r),y=null==f?void 0:f.selfType;return Z.includes(y)&&Y.includes(c)?f.copy[c]:(u=L(u,{key:c,parentMeta:f,parentType:y,ver:e,traps:i,parent:r,patches:n,fastModeRange:l,immutBase:p,readOnly:d,inversePatches:o,usePatches:m}),y===a&&A(c)?(M("get",c,f),u):s[y]?(u=H(r,{op:c,key:c,value:u,metaVer:e,calledBy:"get",patches:n,inversePatches:o,usePatches:m,parentType:y,parentMeta:f}),M("get",c,f),u):(M("get",c,f),u))},set:(t,n,o)=>{let s=o;if(d)return ee();if(V(o))if(c=e,x(i=o)&&N(i).ver!==c)r=!1;else if(s=X(o),s===t[n])return!0;var i,c;const u=N(t);if(u&&u.selfType===a){if(u.copy&&u.__callSet&&A(n))return u.copy[n]=s,M("set",n,u),!0;u.__callSet=!0}return H(t,{parentMeta:u,key:n,value:s,metaVer:e,calledBy:"set"}),M("set",n,u),!0},deleteProperty:(t,r)=>{if(d)return ee();const n=N(t);return H(t,{parentMeta:n,op:"del",key:r,value:"",metaVer:e,calledBy:"deleteProperty"}),M("del",r,n),!0},apply:function(e,t,r){return e.apply(t,r)}};return{createDraft:t=>{if(D(t))throw new Error("base state can not be primitive");let r=t;const n=N(t);if(n){if(p&&n.isImmutBase)return n.proxyVal;r=n.self}const o=J(r,{key:"",ver:e,traps:i,finishDraft:g.finishDraft,immutBase:p,readOnly:d,extraProps:y});return G(o),o.proxyVal},finishDraft:e=>{const t=N(e);if(!t)throw new Error("rootMeta should not be null!");if(0!==t.level)throw new Error("can not finish sub draft node!");if(t.isImmutBase)return e;let n=W(t);return h&&r&&(n=Q(n)),n}}})();return g}const re={noop:j,isObject:x,isMap:E,isSet:T,isFn:w,isPrimitive:D,isPromiseFn:_,isPromiseResult:B,isSymbol:F,canBeNum:A,isDraft:V,isDiff:$,shallowCompare:function(e,t){return!((e,t)=>{for(let r in e)if(!(r in t))return!0;for(let r in t)if($(e[r],t[r]))return!0;return!1})(e,t)},getDraftMeta:C};function ne(e,t){return te(t).createDraft(e)}function oe(e){const t=C(e);let r=null;if(t&&(r=t.finishDraft),!r)throw new Error("not a Limu draft!");return r(e)}function ae(e){if(!w(e))throw new Error("produce callback is not a function")}function se(e,t,r){ae(t);const n=ne(e,r),o=t(n);return function(e,t){if(_(e)||B(t))throw new Error("produce callback can not be a promise function or result")}(t,o),oe(n)}const ie=function(e,t,r){if(!t||!w(t)){const r=e,n=t;return ae(e),e=>se(e,r,n)}return se(e,t,r)},ce=Q;const ue=function(e){const t=C(e);return t?t.self:e},fe=function(e){const t=C(e);return t?K(t.copy||t.self):e};e.VER="3.5.0",e.createDraft=ne,e.current=fe,e.deepCopy=function(e){return K(e)},e.deepFreeze=ce,e.default=ie,e.finishDraft=oe,e.getAutoFreeze=function(){return O.autoFreeze},e.immut=function(e,t){return te(Object.assign(Object.assign({},t||{}),{readOnly:!0,[r]:!0})).createDraft(e)},e.innerUtil=re,e.original=ue,e.produce=ie,e.setAutoFreeze=function(e){O.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
