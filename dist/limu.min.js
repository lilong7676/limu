!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a,o=function(){return o=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},o.apply(this,arguments)};function i(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}var f={Map:"Map",Set:"Set",Array:"Array"},l="[object Object]",u="[object Map]",c="[object Set]",p="[object Array]",s="[object Function]",y=((r={})[u]=f.Map,r[c]=f.Set,r[p]=f.Array,r[l]="Object",r),d=["length","slice","concat","find","findIndex","filter","flat","flatMap","includes","indexOf","every","some","constructor","join","keys","lastIndexOf","reduce","reduceRight","values","entries","valueOf"],v=i(i([],["entries","keys","values","has"],!0),["size"],!1),h=i(i([],["entries","has","keys","values"],!0),["size"],!1),m=((t={})[f.Map]=["clear","delete","entries","forEach","get","has","keys","set","values"],t[f.Set]=["add","clear","delete","entries","forEach","has","keys","values"],t[f.Array]=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),M=((n={})[f.Map]=["clear","delete","set"],n[f.Set]=["add","clear","delete"],n[f.Array]=["copyWithin","fill","pop","push","reverse","shift","unshift","splice"],n),b=((a={})[f.Map]=["forEach","get"],a[f.Set]=["forEach"],a[f.Array]=["forEach","map"],a),x=Object.prototype.toString;function _(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function g(e){return x.call(e)===l}function S(e){return x.call(e)===u}function w(e){return x.call(e)===c}function A(e){return x.call(e)===s}function O(e){var r=x.call(e);return![l,p,u,c,s].includes(r)}function j(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}function E(e){return"symbol"==typeof e}function k(e){return!(!e||O(e))&&Object.isFrozen(e)}var I=Symbol("verKey"),D=Symbol("metas"),P=Symbol("finishHandler"),T=Symbol("isModifiedKey"),V={},z={value:0},F={autoFreeze:!0};function B(e,r,t){var n=[r],a=N(e,t);return a&&a.level>0?i(i([],a.keyPath,!0),[r],!1):n}function N(e,r){var t=W(e);return t?t[r]:null}function L(e,r){return e?N(e.__proto__,r):null}function W(e){return e?e[D]:null}function K(e,r){var t=e.self;if(Array.isArray(t))return e.proxyItems||t.slice();if(g(t))return o({},t);if(S(t))return e.proxyItems||r||new Map(t);if(w(t))return e.proxyItems||r||new Set(t);throw new Error("data ".concat(t," try trigger getCopy, its type is ").concat(typeof e))}function R(e){return Array.isArray(e)?e.slice():e&&g(e)?o({},e):S(e)?new Map(e):w(e)?new Set(e):e}function C(e,r,t){var n=W(e);n&&(n[t]=r)}function H(e,r){var t=N(e,r);return t?t.level+1:1}function J(e){return Object.getPrototypeOf(e)?Object.getPrototypeOf(e):Object.prototype}function $(e,r){var t=Object.create(null);Object.setPrototypeOf(t,r),Object.setPrototypeOf(e,t),e.__proto__[D]={}}function q(e){return!!(null==e?void 0:e[I])}function G(e){var r,t=(r=e,x.call(r));return y[t]}function Q(e){return Array.isArray(e)||w(e)||S(e)||Object.getOwnPropertyNames(e).forEach((function(r){var t=e[r];t instanceof Object&&null!==t&&Q(t)})),Object.freeze(e)}function U(e,r,t){var n,a=e.parentMeta,o=e.parentType,i=e.selfType,f=e.idx,l=e.copy;if("set"===r&&j(t)&&"Array"===i){var u=e.proxyItems;u&&(u[T]=!0)}if(a){var c=a.copy;c||(c=K(a),a.copy=c);var p=!1;"Map"===o?(c.set(f,l),p=!0):"Object"===o?c[f]=l:"Array"===o?(c[f]=l,p=!0):"Set"===o&&(p=!0);var s=a.proxyItems;p&&s&&(s[T]=!0,s.__parent=null===(n=a.parentMeta)||void 0===n?void 0:n.copy,s.__dataIndex=a.idx)}}function X(e,r,t){if(null==e?void 0:e.rootMeta){e.rootMeta.modified=!0;var n=N(r,t);n&&U(n)}}function Y(e,r,t,n,a){var o=r.delete.bind(r),i=r.clear.bind(r);if(r.add=function(){_()},r.set=function(){_()},r.delete=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return X(t,n,a),o.apply(void 0,e)},r.clear=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return X(t,n,a),i.apply(void 0,e)},"Set"===e){var f=r.add.bind(r);r.add=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return X(t,n,a),f.apply(void 0,e)}}if("Map"===e){var l=r.set.bind(r);r.set=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return X(t,n,a),l.apply(void 0,e)}}}var Z=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],ee=["clear","delete","set"],re=["add","clear","delete"];function te(e,r,t){var n=r.op,a=r.key,o=r.value,i=r.metaVer,l=r.calledBy,u=r.parentType,c=N(e,i),p=o;if(t&&(p=function(e,r){var t=L(e,r);if(!t)return e;var n=t.copy;return n||(n=K(t),t.copy=n),n}(o,i)),c){var s=c.self,y=c.rootMeta,b=c.copy,x=function(e,r){if(e===f.Array){if(d.includes(r))return!1;if(j(r))return!1}return!(e===f.Map&&v.includes(r)||e===f.Set&&h.includes(r)||E(r))}(u,n);if(x){if(b&&!["Map","Set"].includes(u)||(b=K(c,b),c.copy=b),!O(p)){var _=N(o,i);_&&_.parentMeta&&_.parentMeta.level!==c.level&&(_.parent=c.self,_.level=c.level+1,_.key=a,_.keyPath=B(_.parent,a,i))}!function(e){var r=e.calledBy,t=e.parentDataNodeMeta,n=e.op,a=e.parentType,o=e.key;(["deleteProperty","set"].includes(r)||"get"===r&&("Set"===a&&re.includes(n)||"Array"===a&&Z.includes(n)||"Map"===a&&ee.includes(n)))&&U(t,r,o)}({calledBy:l,parentDataNodeMeta:c,op:n,key:a,parentType:u});var g=c.parentMeta;if(g){var S={key:c.key,parentType:c.parentType,value:b,metaVer:i,calledBy:l};te(g.self,S,!1)}}var w=function(){c.modified=!0,y&&(y.modified=!0)};if((m[u]||[]).includes(n)&&A(o))return M[u].includes(n)&&w(),"slice"===n?s.slice:b?u===f.Set||u===f.Map?b[n].bind(b):["map","sort"].includes(n)?b[n].bind(c.proxyVal):b[n].bind(c.proxyItems):s[n].bind(s);if(!b)return p;if(t)if("del"===n)delete b[a];else{if("toJSON"===n&&!o)return;b[a]=p}["set","deleteProperty"].includes(l)&&w()}else e[a]=p}function ne(e,r,t){void 0===t&&(t=!1);var n=function(e){return!O(e)}(e);if(n){var a=e[D];return a||($(e,J(e)),a=e[D]),void V[r].push(a)}if(t)throw new Error("base state type can only be object(except null) or array")}var ae=["length","constructor","asymmetricMatch","nodeType","size"],oe=[f.Array,f.Set,f.Map],ie=[f.Set,f.Map],fe=new Map,le=function(e,r,t){var n=e.proxyItemsMgr.Map,a=null;return n.forEach((function(e){if(e[T]){var t=new Map;a=t,e.forEach((function(e,n){var a=N(e,r);if(a){var o=a.modified?a.copy:a.self;t.set(n,o)}})),e.__parent&&(e.__parent[e.__dataIndex]=t)}})),"Map"===e.parentType&&a||t},ue=function(e,r,t){var n=e.proxyItemsMgr.Set,a=null;return n.forEach((function(e){if(e[T]){var t=Array.from(e);a=t,t.forEach((function(e,n){var a=N(e,r);a&&(t[n]=a.modified?a.copy:a.self)})),e.__parent&&(e.__parent[e.__dataIndex]=new Set(t))}})),"Set"===e.parentType&&a?new Set(a):t},ce=function(e,r,t){var n=e.proxyItemsMgr.Array,a=[];return n.forEach((function(e){if(e[T]){var t=N(e,r),n=(null==t?void 0:t.copy)||e;n.forEach((function(e,t){var n=N(e,r);a[t]=n?n.modified?n.copy:n.self:e}));var o=n.__parent;o&&(o[n.__dataIndex]=a)}})),"Array"===e.parentType&&a.length?a:t},pe=function(e){return fe.get(e)},se=function(e,r){fe.set(e,r)};function ye(){var e,r,t,n,a=(e=function(){z.value+=1;var e=z.value;return V[e]=[],e}(),r=!1,t=null,n={get:function(r,t){if(t===I)return e;var a=r[t];if("__proto__"===t||t===P||t===T)return a;if(E(t))return A(a)?a.bind(r):a;var o=G(r),i=N(r,e);if(F.autoFreeze&&k(a)&&(a=K({self:a}),r[t]=a,i&&i.copy&&(i.copy[t]=a)),i&&oe.includes(o)&&ae.includes(t))return i.copy?i.copy[t]:i.self[t];if(i){var l=i.self,u=i.copy,c=l[t];if(!ie.includes(o)&&(u&&(a=u[t]),c!==a&&Array.isArray(c)&&Array.isArray(a)&&i&&!a[D])){var p=N(r[t],e);if(p)return function(e,r){var t=e[D];t||($(e,J(e)),t=e[D]),V[r].push(t)}(a,e),C(a,p,e),p.proxyVal}}var s=function(a,i,l){var u,c;if(void 0===l&&(l=-1),a&&!O(a)){var p=N(a,e);if(A(a)){if(function(e,r){return"Array"===e||(b[e]||[]).includes(r)}(o,t)){if(!(p=N(r,e)))throw new Error("[[ createMeta ]]: oops, meta should not be null");if(!p.proxyItems){var y=[];if(o===f.Set){var d=new Set;r.forEach((function(e){return d.add(s(e,R(e)))})),Y("Set",d,p,r,e),y=d}else if(o===f.Map){var v=new Map;r.forEach((function(e,r){return v.set(r,s(e,R(e),r))})),Y("Map",v,p,r,e),y=v}else if(o===f.Array){var h=[],m=p.copy||r;p.copy=h,m.forEach((function(e,r){return h.push(s(e,R(e),r))})),y=p.proxyVal}p.proxyItems=y;var M=null===(c=null===(u=p.rootMeta)||void 0===u?void 0:u.proxyItemsMgr)||void 0===c?void 0:c[o];M&&M.push(y)}}return a}if(ne(a,e),!p){p={rootMeta:null,parentMeta:null,parent:r,parentType:o,selfType:G(a),self:a,key:t,idx:l,keyPath:B(r,l,e),level:H(r,e),proxyVal:new Proxy(a,n),copy:i,modified:!1,proxyItems:null,proxyItemsMgr:null,finishDraft:_,ver:e};var x=N(r,e);x&&(p.parentMeta=x,p.rootMeta=x.rootMeta),C(a,p,e)}return p.proxyVal}return a};return a=s(a,null,t),o===f.Array&&j(t)?a:f[o]?te(r,{parentType:o,op:t,key:t,value:a,metaVer:e,calledBy:"get"},!0):a},set:function(r,t,n){if(t===T)return r.__proto__[T]=n,!0;var a=N(r,e);if(a){if(a.copy&&a.__callSet&&a.selfType===f.Array&&j(t))return a.copy[t]=n,!0;a.__callSet=!0}return te(r,{key:t,value:n,metaVer:e,calledBy:"set"},!0),!0},deleteProperty:function(r,t){return te(r,{op:"del",key:t,value:"",metaVer:e,calledBy:"deleteProperty"},!0),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(o){if(r)throw new Error("can not call new Limu().createDraft twice");var i=o,f=o;if(r=!0,q(o)){var l=L(o,o[I]);i=l.self,f=l.self}F.autoFreeze&&!k(i)&&Q(i),k(i)&&(i=pe(f)||K({self:i}),se(f,i)),ne(i,e,!0);var u=N(i,e);if(!u){var c=G(i);(u={rootMeta:null,parent:null,parentMeta:null,parentType:c,selfType:c,self:i,originalSelf:f,copy:null,modified:!1,key:"",keyPath:[],idx:-1,level:0,proxyVal:null,proxyItems:null,proxyItemsMgr:{Map:[],Set:[],Array:[]},finishDraft:a.finishDraft,ver:e}).rootMeta=u,C(i,u,e)}var p=Proxy.revocable(i,n),s=p.proxy,y=p.revoke;return u.proxyVal=s,t=y,s},finishDraft:function(r){if(e!==r[I])throw new Error("oops, the input draft does not match finishDraft handler");var n=L(r,e);if(!n)throw new Error("oops, rootMeta should not be null!");var a=n.originalSelf||n.self;return n.copy&&n.modified&&(a=n.copy,a=le(n,e,a),a=ue(n,e,a),a=ce(n,e,a)),t&&t(),function(e){V[e].forEach((function(r){return delete r[e]}))}(e),a}});return a}var de=function(){var e=ye();this.createDraft=e.createDraft,this.finishDraft=e.finishDraft};function ve(e){return(new de).createDraft(e)}function he(e){var r=L(e,e[I]),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function me(e){if("function"!=typeof e)throw new Error("produce callback is not a function")}function Me(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function");var t}function be(e,r){me(r);var t=ve(e),n=r(t);return Me(r,n),he(t)}var xe=q,_e=function(e,r){return r?be(e,r):(me(e),function(r){return be(r,e)})};e.Limu=de,e.createDraft=ve,e.finishDraft=he,e.getDraftMeta=function(e){return L(e,e[I])},e.isDraft=xe,e.produce=_e,e.setAutoFreeze=function(e){F.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
