!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a,o=function(){return o=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},o.apply(this,arguments)};function i(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}var l={Map:"Map",Set:"Set",Array:"Array"},f="[object Object]",c="[object Map]",u="[object Set]",p="[object Array]",s="[object Function]",y=((r={})[c]=l.Map,r[u]=l.Set,r[p]=l.Array,r[f]="Object",r),d=["length","slice","concat","find","findIndex","filter","flat","flatMap","includes","indexOf","every","some","constructor","join","keys","lastIndexOf","reduce","reduceRight","values","entries","valueOf"],v=i(i([],["entries","keys","values","has"],!0),["size"],!1),h=i(i([],["entries","has","keys","values"],!0),["size"],!1),m=((t={})[l.Map]=["clear","delete","entries","forEach","get","has","keys","set","values"],t[l.Set]=["add","clear","delete","entries","forEach","has","keys","values"],t[l.Array]=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),M=((n={})[l.Map]=["clear","delete","set"],n[l.Set]=["add","clear","delete"],n[l.Array]=["copyWithin","fill","pop","push","reverse","shift","unshift","splice"],n),b=((a={})[l.Map]=["forEach","get"],a[l.Set]=["forEach"],a[l.Array]=["forEach","map"],a),x=Object.prototype.toString;function _(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function g(e){return x.call(e)===f}function S(e){return x.call(e)===c}function w(e){return x.call(e)===u}function A(e){return x.call(e)===s}function k(e){var r=x.call(e);return![f,p,c,u,s].includes(r)}function E(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}function O(e){return"symbol"==typeof e}var I=Symbol("verKey"),j=Symbol("metas"),P=Symbol("finishHandler"),T=Symbol("isModifiedKey"),D={},V={value:0};function B(e,r,t){var n=[r],a=K(e,t);return a&&a.level>0?i(i([],a.keyPath,!0),[r],!1):n}function K(e,r){var t=L(e);return t?t[r]:null}function z(e,r){return e?K(e.__proto__,r):null}function L(e){return e?e[j]:null}function N(e,r){var t=e.self;if(Array.isArray(t))return e.proxyItems||t.slice();if(g(t))return o({},t);if(S(t))return e.proxyItems||r||new Map(t);if(w(t))return e.proxyItems||r||new Set(t);throw new Error("data ".concat(t," try trigger getCopy, its type is ").concat(typeof e))}function R(e){return Array.isArray(e)?e.slice():e&&g(e)?o({},e):S(e)?new Map(e):w(e)?new Set(e):e}function W(e,r,t){var n=L(e);n&&(n[t]=r)}function F(e,r){var t=K(e,r);return t?t.level+1:1}function C(e){return Object.getPrototypeOf(e)?Object.getPrototypeOf(e):Object.prototype}function G(e,r){var t=Object.create(null);Object.setPrototypeOf(t,r),Object.setPrototypeOf(e,t),e.__proto__[j]={}}function H(e){return!!(null==e?void 0:e[I])}function J(e){var r,t=(r=e,x.call(r));return y[t]}function $(e,r,t){var n,a=e.parentMeta,o=e.parentType,i=e.selfType,l=e.idx,f=e.copy;if("set"===r&&E(t)&&"Array"===i){var c=e.proxyItems;c&&(c[T]=!0)}if(a){var u=a.copy;u||(u=N(a),a.copy=u);var p=!1;"Map"===o?(u.set(l,f),p=!0):"Object"===o?u[l]=f:"Array"===o?(u[l]=f,p=!0):"Set"===o&&(p=!0);var s=a.proxyItems;p&&s&&(s[T]=!0,s.__parent=null===(n=a.parentMeta)||void 0===n?void 0:n.copy,s.__dataIndex=a.idx)}}function q(e,r,t){if(null==e?void 0:e.rootMeta){e.rootMeta.modified=!0;var n=K(r,t);n&&$(n)}}function Q(e,r,t,n,a){var o=r.delete.bind(r),i=r.clear.bind(r);if(r.add=function(){_()},r.set=function(){_()},r.delete=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return q(t,n,a),o.apply(void 0,e)},r.clear=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return q(t,n,a),i.apply(void 0,e)},"Set"===e){var l=r.add.bind(r);r.add=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return q(t,n,a),l.apply(void 0,e)}}if("Map"===e){var f=r.set.bind(r);r.set=function(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return q(t,n,a),f.apply(void 0,e)}}}var U=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],X=["clear","delete","set"],Y=["add","clear","delete"];function Z(e,r,t){var n=r.op,a=r.key,o=r.value,i=r.metaVer,f=r.calledBy,c=r.parentType,u=K(e,i),p=o;if(t&&(p=function(e,r){var t=z(e,r);if(!t)return e;var n=t.copy;return n||(n=N(t),t.copy=n),n}(o,i)),u){var s=u.self,y=u.rootMeta,b=u.copy,x=function(e,r){if(e===l.Array){if(d.includes(r))return!1;if(E(r))return!1}return!(e===l.Map&&v.includes(r)||e===l.Set&&h.includes(r)||O(r))}(c,n);if(x){if(b&&!["Map","Set"].includes(c)||(b=N(u,b),u.copy=b),!k(p)){var _=K(o,i);_&&_.parentMeta&&_.parentMeta.level!==u.level&&(_.parent=u.self,_.level=u.level+1,_.key=a,_.keyPath=B(_.parent,a,i))}!function(e){var r=e.calledBy,t=e.parentDataNodeMeta,n=e.op,a=e.parentType,o=e.key;(["deleteProperty","set"].includes(r)||"get"===r&&("Set"===a&&Y.includes(n)||"Array"===a&&U.includes(n)||"Map"===a&&X.includes(n)))&&$(t,r,o)}({calledBy:f,parentDataNodeMeta:u,op:n,key:a,parentType:c});var g=u.parentMeta;if(g){var S={key:u.key,parentType:u.parentType,value:b,metaVer:i,calledBy:f};Z(g.self,S,!1)}}var w=function(){u.modified=!0,y&&(y.modified=!0)};if((m[c]||[]).includes(n)&&A(o))return M[c].includes(n)&&w(),"slice"===n?s.slice:b?c===l.Set||c===l.Map?b[n].bind(b):["map","sort"].includes(n)?b[n].bind(u.proxyVal):b[n].bind(u.proxyItems):s[n].bind(s);if(!b)return p;if(t)if("del"===n)delete b[a];else{if("toJSON"===n&&!o)return;b[a]=p}["set","deleteProperty"].includes(f)&&w()}else e[a]=p}function ee(e,r,t){void 0===t&&(t=!1);var n=function(e){return!k(e)}(e);if(n){var a=e[j];return a||(G(e,C(e)),a=e[j]),void D[r].push(a)}if(t)throw new Error("base state type can only be object(except null) or array")}function re(e,r){var t=e[j];t||(G(e,C(e)),t=e[j]),D[r].push(t)}var te=["length","constructor","asymmetricMatch","nodeType","size"],ne=[l.Array,l.Set,l.Map],ae=[l.Set,l.Map],oe=function(e,r,t){var n=e.proxyItemsMgr.Map,a=null;return n.forEach((function(e){if(e[T]){var t=new Map;a=t,e.forEach((function(e,n){var a=K(e,r);if(a){var o=a.modified?a.copy:a.self;t.set(n,o)}})),e.__parent&&(e.__parent[e.__dataIndex]=t)}})),"Map"===e.parentType&&a||t},ie=function(e,r,t){var n=e.proxyItemsMgr.Set,a=null;return n.forEach((function(e){if(e[T]){var t=Array.from(e);a=t,t.forEach((function(e,n){var a=K(e,r);a&&(t[n]=a.modified?a.copy:a.self)})),e.__parent&&(e.__parent[e.__dataIndex]=new Set(t))}})),"Set"===e.parentType&&a?new Set(a):t},le=function(e,r,t){var n=e.proxyItemsMgr.Array,a=[];return n.forEach((function(e){if(e[T]){var t=K(e,r),n=(null==t?void 0:t.copy)||e;n.forEach((function(e,t){var n=K(e,r);a[t]=n?n.modified?n.copy:n.self:e}));var o=n.__parent;o&&(o[n.__dataIndex]=a)}})),"Array"===e.parentType&&a.length?a:t};function fe(){var e,r,t,n,a=(e=function(){V.value+=1;var e=V.value;return D[e]=[],e}(),r=!1,t=null,n={get:function(r,t){if(t===I)return e;var a=r[t];if("__proto__"===t||t===P||t===T)return a;if(O(t))return A(a)?a.bind(r):a;var o=J(r),i=K(r,e);if(console.log("Get parentType:".concat(o," key:").concat(t," "),"Read KeyPath",B(r,t,e)),i&&ne.includes(o)&&te.includes(t))return i.copy?i.copy[t]:i.self[t];if(i){var f=i.self,c=i.copy,u=f[t];if(!ae.includes(o)&&(_(j,re),c&&(a=c[t]),u!==a)){if(Array.isArray(u)&&Array.isArray(a)&&i&&!a[j]){var p=K(r[t],e);if(p)return re(a,e),W(a,p,e),p.proxyVal}return a}}var s=function(a,i,f){var c,u;if(void 0===f&&(f=-1),a&&!k(a)){var p=K(a,e);if(A(a)){if(function(e,r){return"Array"===e||(b[e]||[]).includes(r)}(o,t)){if(!(p=K(r,e)))throw new Error("[[ createMeta ]]: oops, meta should not be null");if(!p.proxyItems){var y=[];if(o===l.Set){var d=new Set;r.forEach((function(e){return d.add(s(e,R(e)))})),Q("Set",d,p,r,e),y=d}else if(o===l.Map){var v=new Map;r.forEach((function(e,r){return v.set(r,s(e,R(e),r))})),Q("Map",v,p,r,e),y=v}else if(o===l.Array){var h=[],m=p.copy||r;p.copy=h,m.forEach((function(e,r){return h.push(s(e,R(e),r))})),y=p.proxyVal}p.proxyItems=y;var M=null===(u=null===(c=p.rootMeta)||void 0===c?void 0:c.proxyItemsMgr)||void 0===u?void 0:u[o];M&&M.push(y)}}return a}if(ee(a,e),!p){p={rootMeta:null,parentMeta:null,parent:r,parentType:o,selfType:J(a),self:a,key:t,idx:f,keyPath:B(r,f,e),level:F(r,e),proxyVal:new Proxy(a,n),copy:i,modified:!1,proxyItems:null,proxyItemsMgr:null,finishDraft:_,ver:e};var x=K(r,e);x&&(p.parentMeta=x,p.rootMeta=x.rootMeta),W(a,p,e)}return p.proxyVal}return a};return a=s(a,null,t),o===l.Array&&E(t)?a:l[o]?Z(r,{parentType:o,op:t,key:t,value:a,metaVer:e,calledBy:"get"},!0):a},set:function(r,t,n){if(console.log("Set ",r,t,n,"Set KeyPath",B(r,t,e)),t===T)return r.__proto__[T]=n,!0;var a=K(r,e);if(a){if(a.copy&&a.__callSet&&a.selfType===l.Array&&E(t))return a.copy[t]=n,!0;a.__callSet=!0}return Z(r,{key:t,value:n,metaVer:e,calledBy:"set"},!0),!0},deleteProperty:function(r,t){return Z(r,{op:"del",key:t,value:"",metaVer:e,calledBy:"deleteProperty"},!0),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(o){if(r)throw new Error("can not call new Limu().createDraft twice");var i=o;r=!0,H(o)&&(i=z(o,o[I]).self),ee(i,e,!0);var l=K(i,e);if(!l){var f=J(i);(l={rootMeta:null,parent:null,parentMeta:null,parentType:f,selfType:f,self:i,copy:null,modified:!1,key:"",keyPath:[],idx:-1,level:0,proxyVal:null,proxyItems:null,proxyItemsMgr:{Map:[],Set:[],Array:[]},finishDraft:a.finishDraft,ver:e}).rootMeta=l,W(i,l,e)}var c=Proxy.revocable(i,n),u=c.proxy,p=c.revoke;return l.proxyVal=u,t=p,u},finishDraft:function(r){if(e!==r[I])throw new Error("oops, the input draft does not match finishDraft handler");var n=z(r,e);if(!n)throw new Error("oops, rootMeta should not be null!");var a=n.self;return n.copy&&n.modified&&(a=n.copy,a=oe(n,e,a),a=ie(n,e,a),a=le(n,e,a)),t&&t(),function(e){D[e].forEach((function(r){return delete r[e]}))}(e),a}});return a}var ce=function(){var e=fe();this.createDraft=e.createDraft,this.finishDraft=e.finishDraft};function ue(e){return(new ce).createDraft(e)}function pe(e){var r=z(e,e[I]),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function se(e){if("function"!=typeof e)throw new Error("produce callback is not a function")}function ye(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function");var t}function de(e,r){se(r);var t=ue(e),n=r(t);return ye(r,n),pe(t)}var ve=H,he=function(e,r){return r?de(e,r):(se(e),function(r){return de(r,e)})};e.Limu=ce,e.createDraft=ue,e.finishDraft=pe,e.getDraftMeta=function(e){return z(e,e[I])},e.isDraft=ve,e.produce=he,Object.defineProperty(e,"__esModule",{value:!0})}));
