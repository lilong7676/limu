!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).limu={})}(this,(function(e){"use strict";var r,t,n,a=function(){return a=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},a.apply(this,arguments)};function o(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}"function"==typeof SuppressedError&&SuppressedError;var i=Symbol("M"),u=Symbol("IMMUT_BASE"),f="Map",c="Set",l="Array",s={Map:f,Set:c,Array:l},p="[object Object]",y="[object Map]",v="[object Set]",d="[object Array]",h="[object Function]",m=((r={})[y]=f,r[v]=c,r[d]=l,r[p]="Object",r),b=["push","pop","shift","splice","unshift","reverse","copyWithin","delete","fill"],M=["clear","delete","set"],k=["add","clear","delete"];o(o([],["entries","keys","values","has"],!0),["size"],!1);o(o([],["entries","has","keys","values"],!0),["size"],!1);var g,P=((t={}).Map=["clear","delete","entries","forEach","get","has","keys","set","values"],t.Set=["add","clear","delete","entries","forEach","has","keys","values"],t.Array=["concat","copyWithin","entries","every","fill","filter","find","findIndex","flat","flatMap","forEach","includes","indexOf","join","keys","lastIndexOf","map","pop","push","reduce","reduceRight","reverse","shift","unshift","slice","some","sort","splice","values","valueOf"],t),O=((n={}).Map=["forEach","get"],n.Set=["forEach"],n.Array=["forEach","map"],n),E=Object.prototype.toString;function T(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return e}function j(e){return E.call(e)===p}function w(e){return E.call(e)===y}function x(e){return E.call(e)===v}function A(e){return E.call(e)===h}function B(e){var r,t=(r=e,E.call(r));return m[t]}function D(e){var r=E.call(e);return![p,d,y,v,h].includes(r)}function S(e){var r=typeof e;return"number"===r||"string"===r&&/^[0-9]*$/.test(e)}var _=((g={})[p]=Object.prototype,g[d]=Array.prototype,g[y]=Map.prototype,g[v]=Set.prototype,g[h]=Function.prototype,g);var z={value:0,usablePrefix:1},V={autoFreeze:!1,usePatches:!1,fastModeRange:"array"};function F(e){e.rootMeta.modified=!0;var r=function(e){e&&!e.modified&&(e.modified=!0,r(e.parentMeta))};r(e)}function R(e,r,t){var n,a,o,u;return t?e[i]=r:(n=e,a=E.call(n),o=_[a]||Object.prototype,u=Object.create(null),Object.setPrototypeOf(u,o),Object.setPrototypeOf(n,u),e.__proto__[i]=r),e}function I(e,r){var t=r.finishDraft,n=r.ver,a=r.parentMeta,i=void 0===a?null:a,u=r.key,f=r.immutBase,c=B(e),l=[],s=0,p=null;i&&(s=function(e){var r=C(e);return r?r.level+1:1}(p=i.copy),l=function(e,r){var t=[r],n=C(e);return n&&n.level>0?o(o([],n.keyPath,!0),[r],!1):t}(p,u));var y={rootMeta:null,parentMeta:i,parent:p,selfType:c,self:e,copy:null,key:u,keyPath:l,level:s,proxyVal:null,proxyItems:null,modified:!1,scopes:[],isImmutBase:f,isDel:!1,linkCount:1,finishDraft:t,ver:n,revoke:T};return y.rootMeta=0===s?y:i.rootMeta,y}function N(e){if(D(e))return!1;var r=e[i];return!!r&&!r.isImmutBase}function C(e){return e[i]}function W(e){return e?e[i]:null}function G(e,r){var t=function(e){if(D(e))return e;if(r){var n=C(e),a=null==n?void 0:n.copy;if(a&&n.level>0)return a}var o=e;if(Array.isArray(e)&&(o=e.slice()).forEach((function(e,r){o[r]=t(e)})),x(e)){var i=Array.from(e);i.forEach((function(e,r){i[r]=t(e)})),o=new Set(i)}return w(e)&&(o=new Map(e)).forEach((function(e,r){o.set(r,t(e))})),j(e)&&(o={},Object.keys(e).forEach((function(r){o[r]=t(e[r])}))),o};return t(e)}function J(e,r,t){if(!t.immutBase){var n=function(e,r){var t=r.parentType,n=r.fastModeRange;if(Array.isArray(e))return{copy:e.slice(),fast:!1};var o="array"===n&&t===l||"all"===n,i=e;return e&&j(e)&&(i=a({},e)),w(e)&&(i=new Map(e)),x(e)&&(i=new Set(e)),{copy:i,fast:o}}(e,t);return R(n.copy,r,n.fast)}return R(e,r,!1)}function L(e){var r=e.self,t=e.copy,n=e.modified,a=r;return t&&n&&(a=e.copy),function(e){e.scopes.forEach((function(e){var r=e.modified,t=e.copy,n=e.parentMeta,a=e.key,o=e.self,u=e.revoke,s=e.proxyVal,p=e.isDel;if(!t)return u();if(delete t[i],!n)return u();var y=r?t:o,v=n.copy,d=n.selfType;return d===f?(v.set(a,y),u()):d===c?(v.delete(s),v.add(y),u()):d===l||!0!==p?(v[a]=y,u()):void 0})),e.scopes.length=0}(e),a}function U(e){e.rootMeta.scopes.push(e)}function X(e,r){var t=r.finishDraft,n=void 0===t?T:t,a=r.ver,o=r.traps,i=r.parentType,u=r.parentMeta,f=r.key,c=r.fastModeRange,l=r.immutBase,s=I(e,{finishDraft:n,ver:a,parentMeta:u,key:f,immutBase:l}),p=J(e,s,{parentType:i,fastModeRange:c,immutBase:l});if(s.copy=p,l){var y=new Proxy(p,o);s.proxyVal=y,s.revoke=T}else{y=Proxy.revocable(p,o);s.proxyVal=y.proxy,s.revoke=y.revoke}return s}function $(e,r){var t=r.key,n=r.parentMeta,a=r.ver,o=r.traps,i=r.parent,u=r.patches,s=r.inversePatches,p=r.usePatches,y=r.parentType,v=r.fastModeRange,d=r.immutBase,h=r.readOnly,m=function(e,r){if(D(e)||!e)return e;var t=r||"",b=C(e);if(!A(e))return b||(U(b=X(e,{key:t,parentMeta:n,parentType:y,ver:a,traps:o,fastModeRange:v,immutBase:d,readOnly:h})),i[t]=b.copy),b.proxyVal;if(!function(e,r){return e===l||(O[e]||[]).includes(r)}(y,t))return e;if(!n)throw new Error("[[ createMeta ]]: oops, meta should not be null");if(n.proxyItems)return e;var M=[];if(y===c){var k=new Set;i.forEach((function(e){return k.add(m(e))})),H(k,n,{dataType:c,patches:u,inversePatches:s,usePatches:p}),M=R(k,n,v),n.copy=M}else if(y===f){var g=new Map;i.forEach((function(e,r){return g.set(r,m(e,r))})),H(g,n,{dataType:f,patches:u,inversePatches:s,usePatches:p}),M=R(g,n,v),n.copy=M}else y===l&&"sort"!==t&&(n.copy=n.copy||i.slice(),M=n.proxyVal);return n.proxyItems=M,e};return m(e,t)}function q(e){if(!j(e))return e;var r=C(e);return r?r.copy:e}function H(e,r,t){var n=t.dataType,a=e.delete.bind(e),o=e.clear.bind(e);if(e.delete=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return F(r),a.apply(void 0,e)},e.clear=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return F(r),o.apply(void 0,e)},n===c){var i=e.add.bind(e);e.add=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return F(r),i.apply(void 0,e)}}if(n===f){var u=e.set.bind(e);e.set=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return F(r),u.apply(void 0,e)}}}function K(e,r){var t=r.op,n=r.key,a=r.value,o=r.calledBy,i=r.parentType,u=r.parentMeta;if("toJSON"!==t||a){var s=q(a);if(u){var p=u.self,y=u.copy;if(function(e){var r=e.calledBy,t=e.parentMeta,n=e.op,a=e.parentType;(["deleteProperty","set"].includes(r)||"get"===r&&(a===c&&k.includes(n)||a===l&&b.includes(n)||a===f&&M.includes(n)))&&F(t)}({calledBy:o,parentMeta:u,op:t,key:n,parentType:i}),(P[i]||[]).includes(t)&&A(a))return"slice"===t?p.slice:y?i===c||i===f?y[t].bind(y):y[t]:p[t].bind(p);if(!y)return s;var v=y[n],d=function(){var e=W(v);e&&(e.isDel=!0)};if("deleteProperty"===o){var h=W(a);return h?h.isDel=!0:d(),void delete y[n]}y[n]=s,d(),function(){var e=W(a);e&&(e.isDel=!1)}()}else e[n]=s}}function Q(e){if(D(e))return e;if(Array.isArray(e)&&e.length>0)return e.forEach(Q),Object.freeze(e);if(x(e)){var r=e;return r.add=function(){return r},r.delete=function(){return!1},r.clear=T,Object.freeze(e)}if(w(e)){var t=e;return t.set=function(){return t},t.delete=function(){return!1},t.clear=T,Object.freeze(e)}return Object.getOwnPropertyNames(e).forEach((function(r){var t=e[r];t instanceof Object&&null!==t&&Q(t)})),Object.freeze(e)}var Y=["length","constructor","asymmetricMatch","nodeType","size"],Z=[l,c,f];function ee(e){var r,t,n,a,o,f,c,p,y,v=e||{},d=v.onOperate||T,h=v.fastModeRange||V.fastModeRange,m=null!==(r=v[u])&&void 0!==r&&r,b=null!==(t=v.readOnly)&&void 0!==t&&t,M=null!==(n=v.autoFreeze)&&void 0!==n?n:V.autoFreeze,k=null!==(a=v.usePatches)&&void 0!==a?a:V.usePatches,g=(o=function(){z.value>=Number.MAX_SAFE_INTEGER?(z.value=1,z.usablePrefix+=1):z.value+=1;var e=z.value,r=z.usablePrefix;return"".concat(r,"_").concat(e)}(),f=!0,c=[],p=[],y={get:function(e,r){var t=e[r];if("__proto__"===r||r===i)return t;if("symbol"==typeof r)return A(t)?t.bind(e):t;var n=C(e),a=null==n?void 0:n.selfType;if(n&&Z.includes(a)&&Y.includes(r))return n.copy[r];t=$(t,{key:r,parentMeta:n,parentType:a,ver:o,traps:y,parent:e,patches:c,fastModeRange:h,immutBase:m,readOnly:b,inversePatches:p,usePatches:k});var u=function(){n&&d({parentType:a,op:"get",keyPath:n.keyPath,key:r,value:t})};return a===l&&S(r)?(u(),t):s[a]?(t=K(e,{op:r,key:r,value:t,metaVer:o,calledBy:"get",patches:c,inversePatches:p,usePatches:k,parentType:a,parentMeta:n}),u(),t):(u(),t)},set:function(e,r,t){var n,a,u=t;if(r===i)return e[r]=u,!0;if(b)return console.warn("modify fail at readOnly mode"),!0;if(N(t))if(a=o,j(n=t)&&C(n).ver!==a)f=!1;else if((u=q(t))===e[r])return!0;var c=C(e),s=function(){c&&d({parentType:c.selfType,op:"set",keyPath:c.keyPath,key:r,value:t})};if(c&&c.selfType===l){if(c.copy&&c.__callSet&&S(r))return c.copy[r]=u,s(),!0;c.__callSet=!0}return K(e,{parentMeta:c,key:r,value:u,metaVer:o,calledBy:"set"}),s(),!0},deleteProperty:function(e,r){var t=C(e);return K(e,{parentMeta:t,op:"del",key:r,value:"",metaVer:o,calledBy:"deleteProperty"}),t&&d({parentType:t.selfType,op:"del",keyPath:t.keyPath,key:r,value:null}),!0},apply:function(e,r,t){return e.apply(r,t)}},{createDraft:function(e){if(D(e))throw new Error("base state can not be primitive");var r=e,t=C(e);if(t){if(m&&t.isImmutBase)return t.proxyVal;r=t.self}var n=X(r,{key:"",ver:o,traps:y,finishDraft:g.finishDraft,immutBase:m,readOnly:b});return U(n),n.proxyVal},finishDraft:function(e){var r=C(e);if(!r)throw new Error("oops, rootMeta should not be null!");if(0!==r.level)throw new Error("oops, can not finish sub draft node!");if(r.isImmutBase)return e;var t=L(r);return M&&f&&(t=Q(t)),t}});return g}function re(e,r){return ee(r).createDraft(e)}function te(e){var r=C(e),t=null;if(r&&(t=r.finishDraft),!t)throw new Error("oops, not a Limu draft!");return t(e)}function ne(e){if(!A(e))throw new Error("produce callback is not a function")}function ae(e,r){if("AsyncFunction"===(t=e).constructor.name||"function"==typeof t.then||function(e){return"undefined"!=typeof Promise&&e instanceof Promise}(r))throw new Error("produce callback can not be a promise function or result");var t}function oe(e,r,t){ne(r);var n=re(e,t),a=r(n);return ae(r,a),te(n)}var ie=C,ue=N,fe=function(e,r,t){if(!r||!A(r)){var n=e,a=r;return ne(e),function(e){return oe(e,n,a)}}return oe(e,r,t)},ce=Q;var le=function(e){if(D(e))return e;var r=C(e);return(null==r?void 0:r.self)||e},se=function(e){if(D(e))return e;var r=C(e);return r?G(r.copy||r.self):e};e.VER="3.3.2",e.createDraft=re,e.current=se,e.deepCopy=function(e){return G(e)},e.deepFreeze=ce,e.default=fe,e.finishDraft=te,e.getAutoFreeze=function(){return V.autoFreeze},e.getDraftMeta=ie,e.getMajorVer=function(){return 3},e.immut=function(e){var r;return ee(((r={readOnly:!0})[u]=!0,r)).createDraft(e)},e.isDraft=ue,e.original=le,e.produce=fe,e.setAutoFreeze=function(e){V.autoFreeze=e},Object.defineProperty(e,"__esModule",{value:!0})}));
